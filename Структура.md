# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ VPN Server Manager v4.0.9

## üìã –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞

**VPN Server Manager** - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è VPN-—Å–µ—Ä–≤–µ—Ä–∞–º–∏ —Å –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π, —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º (macOS, Windows, Linux, Docker).

**–°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π:**
- Backend: Flask (Python 3.8+)
- Frontend: HTML5, Bootstrap 5, JavaScript
- Desktop UI: PyWebView (–∫—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–∞—è –æ–±–µ—Ä—Ç–∫–∞)
- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ: Fernet (AES-128 + HMAC-SHA256)
- SSH: Paramiko —Å –ø—É–ª–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- i18n: Flask-Babel (—Ä—É—Å—Å–∫–∏–π, –∞–Ω–≥–ª–∏–π—Å–∫–∏–π, –∫–∏—Ç–∞–π—Å–∫–∏–π)
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: Pytest —Å coverage
- –°–±–æ—Ä–∫–∞: PyInstaller, Docker

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π

```
vpn-server-manager/
‚îú‚îÄ‚îÄ app/                          # –û—Å–Ω–æ–≤–Ω–æ–µ Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py              # Application Factory
‚îÇ   ‚îú‚îÄ‚îÄ config.py                # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ exceptions.py            # –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ models/                  # –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ server.py           # –ú–æ–¥–µ–ª—å Server (dataclass)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ server_connection.py # –ú–æ–¥–µ–ª—å ServerConnection
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ server_stats.py     # –ú–æ–¥–µ–ª—å ServerStats
‚îÇ   ‚îú‚îÄ‚îÄ routes/                  # –ú–∞—Ä—à—Ä—É—Ç—ã –∏ API endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.py             # –û—Å–Ω–æ–≤–Ω—ã–µ –≤–µ–±-–º–∞—Ä—à—Ä—É—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api.py              # RESTful API endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pin.py              # PIN –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ vendor.py           # Vendor —Ñ–∞–π–ª—ã (bootstrap, icons)
‚îÇ   ‚îú‚îÄ‚îÄ services/                # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (Service Layer)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py         # ServiceRegistry
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ssh_service.py      # SSH/SFTP –æ–ø–µ—Ä–∞—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ crypto_service.py   # –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ/–¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ data_manager_service.py # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ api_service.py      # –í–Ω–µ—à–Ω–∏–µ API (IP check, location)
‚îÇ   ‚îî‚îÄ‚îÄ utils/                   # –£—Ç–∏–ª–∏—Ç—ã
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îú‚îÄ‚îÄ decorators.py       # –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã (@require_auth, @rate_limit, etc)
‚îÇ       ‚îú‚îÄ‚îÄ validators.py       # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
‚îÇ       ‚îî‚îÄ‚îÄ rate_limiter.py     # Rate limiting (Token Bucket)
‚îú‚îÄ‚îÄ desktop/                     # PyWebView desktop –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îÇ   ‚îî‚îÄ‚îÄ window.py               # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ desktop –æ–∫–Ω–æ–º
‚îú‚îÄ‚îÄ templates/                   # Jinja2 HTML —à–∞–±–ª–æ–Ω—ã
‚îÇ   ‚îú‚îÄ‚îÄ layout.html             # –ë–∞–∑–æ–≤—ã–π layout
‚îÇ   ‚îú‚îÄ‚îÄ index.html              # –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
‚îÇ   ‚îú‚îÄ‚îÄ index_locked.html       # PIN-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ add_server.html         # –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ edit_server.html        # –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ monitoring.html         # Dashboard –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
‚îÇ   ‚îú‚îÄ‚îÄ settings.html           # –ù–∞—Å—Ç—Ä–æ–π–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ help.html               # –°–ø—Ä–∞–≤–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ cheatsheet.html         # –®–ø–∞—Ä–≥–∞–ª–∫–∞ (NGINX, Docker, Systemd)
‚îÇ   ‚îî‚îÄ‚îÄ ...                     # –î—Ä—É–≥–∏–µ —à–∞–±–ª–æ–Ω—ã
‚îú‚îÄ‚îÄ static/                      # –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
‚îÇ   ‚îú‚îÄ‚îÄ css/                    # –°—Ç–∏–ª–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ style.css          # –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ monitoring.css     # –°—Ç–∏–ª–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
‚îÇ   ‚îú‚îÄ‚îÄ js/                     # JavaScript
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ bootstrap.bundle.min.js
‚îÇ   ‚îî‚îÄ‚îÄ images/                 # –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ translations/                # –ü–µ—Ä–µ–≤–æ–¥—ã (i18n)
‚îÇ   ‚îú‚îÄ‚îÄ ru/                     # –†—É—Å—Å–∫–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ en/                     # –ê–Ω–≥–ª–∏–π—Å–∫–∏–π
‚îÇ   ‚îî‚îÄ‚îÄ zh/                     # –ö–∏—Ç–∞–π—Å–∫–∏–π
‚îú‚îÄ‚îÄ tests/                       # –¢–µ—Å—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ conftest.py             # Pytest –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ —Ñ–∏–∫—Å—Ç—É—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ test_routes/            # –¢–µ—Å—Ç—ã –º–∞—Ä—à—Ä—É—Ç–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ test_services/          # –¢–µ—Å—Ç—ã —Å–µ—Ä–≤–∏—Å–æ–≤
‚îú‚îÄ‚îÄ backup_tools/                # –£—Ç–∏–ª–∏—Ç—ã —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
‚îú‚îÄ‚îÄ docs/                        # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ tools/                       # –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ auto_translate_po.py    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ run.py                       # –ì–ª–∞–≤–Ω—ã–π –∑–∞–ø—É—Å–∫–∞—Ç–µ–ª—å (web/desktop)
‚îú‚îÄ‚îÄ run_desktop.py               # –ü—Ä—è–º–æ–π –∑–∞–ø—É—Å–∫ desktop
‚îú‚îÄ‚îÄ setup.py                     # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç–∞
‚îú‚îÄ‚îÄ requirements.txt             # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ Makefile                     # –ö–æ–º–∞–Ω–¥—ã —Å–±–æ—Ä–∫–∏
‚îú‚îÄ‚îÄ Dockerfile                   # Docker –æ–±—Ä–∞–∑
‚îú‚îÄ‚îÄ docker-compose.yml           # Docker Compose
‚îú‚îÄ‚îÄ .env                         # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–Ω–µ –≤ Git)
‚îú‚îÄ‚îÄ config.json                  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–Ω–µ –≤ Git)
‚îú‚îÄ‚îÄ config.json.example          # –®–∞–±–ª–æ–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îî‚îÄ‚îÄ env.example                  # –®–∞–±–ª–æ–Ω .env
```

---

## üîë –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ –∏—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ

### –¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞

#### **run.py** - –ì–ª–∞–≤–Ω—ã–π –∑–∞–ø—É—Å–∫–∞—Ç–µ–ª—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```python
# –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
def main():
    # 1. –ü–∞—Ä—Å–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
    parser = argparse.ArgumentParser()
    parser.add_argument('--desktop', action='store_true')
    parser.add_argument('--debug', action='store_true')

    # 2. –ü–æ–∏—Å–∫ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞ –¥–ª—è multi-instance
    port = find_free_port(start_port=5000, max_attempts=10)

    # 3. –°–æ–∑–¥–∞–Ω–∏–µ Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ Application Factory
    app = create_app('development' if debug else 'production')

    # 4. Graceful shutdown —Å –æ—á–∏—Å—Ç–∫–æ–π SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    def signal_handler(sig, frame):
        ssh_service = registry.get('ssh')
        ssh_service.cleanup_connections()
        sys.exit(0)

    # 5. –ó–∞–ø—É—Å–∫ –≤ web –∏–ª–∏ desktop —Ä–µ–∂–∏–º–µ
    if desktop:
        from desktop.window import start_desktop_app
        start_desktop_app(app, port)
    else:
        app.run(host='127.0.0.1', port=port, threaded=True)
```

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `find_free_port()` - –ø–æ–∏—Å–∫ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞ (5000-5009)
- `signal_handler()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ SIGINT/SIGTERM –¥–ª—è graceful shutdown
- `threaded=True` - –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã–π —Ä–µ–∂–∏–º Flask (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)

---

### Application Factory

#### **app/__init__.py** - –§–∞–±—Ä–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```python
def create_app(config_name='production'):
    """
    Application Factory Pattern –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    """
    # 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Flask
    app = Flask(__name__,
                template_folder='templates',
                static_folder='static')

    # 2. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    app.config.from_object(config_by_name[config_name])

    # 3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º config.json (frozen mode)
    manage_user_config(app)

    # 4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Babel –¥–ª—è i18n
    babel = Babel(app, locale_selector=get_locale)

    # 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    setup_logging(app)

    # 6. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ Service Registry
    register_services(app)

    # 7. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è blueprints
    app.register_blueprint(main_bp)
    app.register_blueprint(api_bp)
    app.register_blueprint(pin_bp)

    # 8. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ—à–∏–±–æ–∫
    register_error_handlers(app)

    # 9. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Å—Å–∏–π
    app.config['SESSION_COOKIE_NAME'] = 'vpn_manager_session_clean'

    # 10. –ó–∞–≥—Ä—É–∑–∫–∞ app_info –∏–∑ config.json
    load_app_info(app)

    return app
```

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `get_locale()` - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞ –ø–æ —Å–µ—Å—Å–∏–∏/–±—Ä–∞—É–∑–µ—Ä—É
- `manage_user_config()` - –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ config.json –≤ APP_DATA_DIR (frozen mode)
- `register_services()` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Service Registry (DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä)
- `load_app_info()` - –∑–∞–≥—Ä—É–∑–∫–∞ –≤–µ—Ä—Å–∏–∏ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏–∑ config.json

---

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

#### **app/config.py** - –°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```python
def get_app_data_dir():
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Ç—å –∫ –¥–∞–Ω–Ω—ã–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
    """
    is_frozen = getattr(sys, 'frozen', False)
    app_name = "VPNServerManager-Clean"

    if is_frozen:
        if sys.platform == 'darwin':  # macOS
            return os.path.join(
                os.path.expanduser("~"),
                "Library", "Application Support",
                app_name
            )
        elif sys.platform == 'win32':  # Windows
            return os.path.join(
                os.getenv('APPDATA'),
                app_name
            )
        else:  # Linux
            return os.path.join(
                os.path.expanduser("~"),
                ".local", "share",
                app_name
            )
    else:
        # Development mode - –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞
        return os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

class Config:
    """–ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è"""
    SECRET_KEY = os.getenv('SECRET_KEY')
    APP_VERSION = os.getenv('APP_VERSION', '4.0.9')
    APP_DATA_DIR = get_app_data_dir()

    # –ü—É—Ç–∏ –∫ –¥–∞–Ω–Ω—ã–º
    DATA_DIR = os.path.join(APP_DATA_DIR, 'data')
    SERVERS_FILE = 'servers.json.enc'

    # API URLs
    IP_CHECK_API = 'https://ipinfo.io/{ip}/json'

    # Babel i18n
    BABEL_DEFAULT_LOCALE = 'ru'
    BABEL_SUPPORTED_LOCALES = ['ru', 'en', 'zh']
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ `.env` –≤ frozen mode —Å –Ω–æ–≤—ã–º SECRET_KEY
- –ü–ª–∞—Ç—Ñ–æ—Ä–º–æ-–∑–∞–≤–∏—Å–∏–º—ã–µ –ø—É—Ç–∏ –∫ –¥–∞–Ω–Ω—ã–º
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–ª–∞—Å—Å—ã: Development, Production, Testing

---

## üîß Service Layer (–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)

### **app/services/__init__.py** - Service Registry (DI)

```python
class ServiceRegistry:
    """
    Dependency Injection –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞–º–∏
    """
    def __init__(self):
        self._services = {}

    def register(self, name: str, service):
        """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞"""
        self._services[name] = service

    def get(self, name: str):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞"""
        return self._services.get(name)

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ä–µ–µ—Å—Ç—Ä —Å–µ—Ä–≤–∏—Å–æ–≤
registry = ServiceRegistry()
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
registry.register('ssh', SSHService())
registry.register('crypto', CryptoService())

# –ü–æ–ª—É—á–µ–Ω–∏–µ
ssh_service = registry.get('ssh')
ssh_service.execute_command(server_id, 'ls -la')
```

---

### **app/services/ssh_service.py** - SSH/SFTP —Å–µ—Ä–≤–∏—Å (44 KB)

**–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**

#### 1. Connection Pooling (–ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π)
```python
class SSHService:
    def __init__(self):
        self.connections = {}  # {server_id: {'client': SSHClient, 'last_used': timestamp}}
        self.connection_locks = {}  # Thread-safe locks
        self.pool_lock = threading.Lock()

    def get_or_create_connection(self, server_id: str, server: Server):
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–µ
        """
        with self.pool_lock:
            if server_id in self.connections:
                conn_info = self.connections[server_id]
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                if self._is_connection_alive(conn_info['client']):
                    conn_info['last_used'] = time.time()
                    return conn_info['client']
                else:
                    # –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è
                    self._close_connection(server_id)

            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            client = self._create_ssh_client(server)
            self.connections[server_id] = {
                'client': client,
                'created_at': time.time(),
                'last_used': time.time()
            }
            return client

    def _is_connection_alive(self, client: paramiko.SSHClient):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"""
        try:
            transport = client.get_transport()
            if transport and transport.is_active():
                transport.send_ignore()  # Keepalive ping
                return True
        except:
            pass
        return False
```

#### 2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SSH –∫–æ–º–∞–Ω–¥
```python
def execute_command(self, server_id: str, command: str, timeout: int = 30):
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç SSH –∫–æ–º–∞–Ω–¥—É –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
    """
    server = self._get_server(server_id)
    client = self.get_or_create_connection(server_id, server)

    try:
        stdin, stdout, stderr = client.exec_command(
            command,
            timeout=timeout,
            get_pty=True  # –ü—Å–µ–≤–¥–æ-—Ç–µ—Ä–º–∏–Ω–∞–ª –¥–ª—è sudo
        )

        # –ß–∏—Ç–∞–µ–º –≤—ã–≤–æ–¥
        output = stdout.read().decode('utf-8', errors='ignore')
        error = stderr.read().decode('utf-8', errors='ignore')
        exit_code = stdout.channel.recv_exit_status()

        return {
            'output': output,
            'error': error,
            'exit_code': exit_code,
            'success': exit_code == 0
        }
    except socket.timeout:
        raise SSHConnectionError(f"Command timeout after {timeout}s")
    except Exception as e:
        raise SSHConnectionError(f"Command execution failed: {e}")
```

#### 3. SFTP –æ–ø–µ—Ä–∞—Ü–∏–∏
```python
def upload_file(self, server_id: str, local_path: str, remote_path: str):
    """–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ SFTP"""
    client = self.get_or_create_connection(server_id, server)
    sftp = client.open_sftp()
    try:
        sftp.put(local_path, remote_path)
        sftp.chmod(remote_path, 0o644)
    finally:
        sftp.close()

def download_file(self, server_id: str, remote_path: str, local_path: str):
    """–°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞"""
    client = self.get_or_create_connection(server_id, server)
    sftp = client.open_sftp()
    try:
        sftp.get(remote_path, local_path)
    finally:
        sftp.close()
```

#### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
```python
def get_network_stats(self, server_id: str):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ç–µ–≤–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
    result = self.execute_command(server_id, """
        cat /proc/net/dev | grep -v lo | awk 'NR>2 {
            print $1, $2, $10
        }'
    """)
    # –ü–∞—Ä—Å–∏–Ω–≥ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    return parsed_stats

def check_firewall_status(self, server_id: str):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ firewall (UFW/iptables)"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º UFW
    ufw_result = self.execute_command(server_id, 'sudo ufw status')
    if 'Status: active' in ufw_result['output']:
        return self._parse_ufw_rules(ufw_result['output'])

    # Fallback –Ω–∞ iptables
    iptables_result = self.execute_command(server_id, 'sudo iptables -L -n')
    return self._parse_iptables_rules(iptables_result['output'])

def get_service_status(self, server_id: str, service_name: str):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ systemd —Å–µ—Ä–≤–∏—Å–∞"""
    result = self.execute_command(
        server_id,
        f'systemctl is-active {service_name}'
    )
    return result['output'].strip() == 'active'
```

#### 5. Cleanup
```python
def cleanup_connections(self):
    """–ó–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (graceful shutdown)"""
    with self.pool_lock:
        for server_id in list(self.connections.keys()):
            self._close_connection(server_id)
        self.connections.clear()
        self.connection_locks.clear()

def cleanup_idle_connections(self, max_idle_time: int = 300):
    """–û—á–∏—Å—Ç–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (5 –º–∏–Ω—É—Ç)"""
    with self.pool_lock:
        current_time = time.time()
        for server_id, conn_info in list(self.connections.items()):
            if current_time - conn_info['last_used'] > max_idle_time:
                self._close_connection(server_id)
```

---

### **app/services/crypto_service.py** - –°–µ—Ä–≤–∏—Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è

```python
class CryptoService:
    def __init__(self):
        self._fernet = None
        self._key = None

    def set_key(self, key: str):
        """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–ª—é—á–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è"""
        if isinstance(key, str):
            key = key.encode()
        self._key = key
        self._fernet = Fernet(key)

    def encrypt_string(self, data: str) -> str:
        """–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏"""
        if not self._fernet:
            raise CryptoError("Encryption key not set")

        encrypted = self._fernet.encrypt(data.encode())
        return base64.b64encode(encrypted).decode()

    def decrypt_string(self, encrypted_data: str) -> str:
        """–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏"""
        if not self._fernet:
            raise CryptoError("Encryption key not set")

        try:
            decoded = base64.b64decode(encrypted_data.encode())
            decrypted = self._fernet.decrypt(decoded)
            return decrypted.decode()
        except Exception as e:
            raise CryptoError(f"Decryption failed: {e}")

    def encrypt_file(self, input_path: str, output_path: str):
        """–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞"""
        with open(input_path, 'rb') as f:
            data = f.read()

        encrypted = self._fernet.encrypt(data)

        with open(output_path, 'wb') as f:
            f.write(encrypted)

    def decrypt_file(self, input_path: str, output_path: str):
        """–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ —Ñ–∞–π–ª–∞"""
        with open(input_path, 'rb') as f:
            encrypted = f.read()

        decrypted = self._fernet.decrypt(encrypted)

        with open(output_path, 'wb') as f:
            f.write(decrypted)

    @staticmethod
    def generate_key() -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞ Fernet"""
        return Fernet.generate_key().decode()
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
crypto = registry.get('crypto')
crypto.set_key(app.config['SECRET_KEY'])

# –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞
encrypted_password = crypto.encrypt_string(server.password)

# –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
crypto.encrypt_file('servers.json', 'servers.json.enc')
```

---

### **app/services/data_manager_service.py** - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏

```python
class DataManagerService:
    def __init__(self, secret_key: str, app_data_dir: str):
        self.crypto = CryptoService()
        self.crypto.set_key(secret_key)
        self.app_data_dir = app_data_dir
        self.data_dir = os.path.join(app_data_dir, 'data')
        os.makedirs(self.data_dir, exist_ok=True)

    def load_servers(self, file_path: str = None) -> List[Server]:
        """
        –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞ (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–ª–∏ –æ–±—ã—á–Ω–æ–≥–æ)
        """
        if not file_path:
            file_path = self._get_active_data_file()

        if not os.path.exists(file_path):
            return []

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é
        if file_path.endswith('.enc'):
            return self._load_encrypted_servers(file_path)
        else:
            return self._load_plain_servers(file_path)

    def _load_encrypted_servers(self, file_path: str) -> List[Server]:
        """–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞"""
        try:
            with open(file_path, 'rb') as f:
                encrypted_data = f.read()

            decrypted_data = self.crypto._fernet.decrypt(encrypted_data)
            data = json.loads(decrypted_data.decode())

            return [Server.from_dict(s) for s in data.get('servers', [])]
        except Exception as e:
            raise CryptoError(f"Failed to decrypt file: {e}")

    def save_servers(self, servers: List[Server], file_path: str = None):
        """
        –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–æ–≤ –≤ —Ñ–∞–π–ª (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–ª–∏ –æ–±—ã—á–Ω—ã–π)
        """
        if not file_path:
            file_path = self._get_active_data_file()

        data = {
            'servers': [s.to_dict() for s in servers],
            'version': '4.0.9',
            'timestamp': datetime.now().isoformat()
        }

        if file_path.endswith('.enc'):
            self._save_encrypted_servers(data, file_path)
        else:
            self._save_plain_servers(data, file_path)

    def _save_encrypted_servers(self, data: dict, file_path: str):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª"""
        json_data = json.dumps(data, indent=2, ensure_ascii=False)
        encrypted = self.crypto._fernet.encrypt(json_data.encode())

        with open(file_path, 'wb') as f:
            f.write(encrypted)

    def import_data(self, source_path: str, target_file: str = None):
        """
        –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞ (.enc, .json, .zip)
        """
        if source_path.endswith('.zip'):
            return self._import_from_zip(source_path, target_file)
        elif source_path.endswith('.enc'):
            return self._import_encrypted(source_path, target_file)
        else:
            return self._import_plain(source_path, target_file)

    def export_data(self, servers: List[Server], export_path: str, encrypt: bool = True):
        """
        –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–∞–π–ª
        """
        if encrypt:
            export_path = export_path.replace('.json', '.enc')
            self.save_servers(servers, export_path)
        else:
            self._save_plain_servers({
                'servers': [s.to_dict() for s in servers],
                'version': '4.0.9',
                'timestamp': datetime.now().isoformat()
            }, export_path)

    def create_png_snapshot(self, server: Server, stats: dict, output_path: str):
        """
        –°–æ–∑–¥–∞–Ω–∏–µ PNG —Å–Ω–∏–º–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
        """
        # HTML —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º html2canvas
        # (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ JavaScript –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ)
        pass
```

---

## üåê Routes (API Endpoints)

### **app/routes/api.py** - RESTful API (68 KB)

**–û—Å–Ω–æ–≤–Ω—ã–µ –≥—Ä—É–ø–ø—ã endpoints:**

#### 1. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞–º–∏
```python
@api_bp.route('/api/servers', methods=['GET'])
@require_auth
def get_servers():
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤"""
    data_manager = registry.get('data_manager')
    servers = data_manager.load_servers()
    return jsonify([s.to_dict() for s in servers])

@api_bp.route('/api/servers', methods=['POST'])
@require_auth
@validate_json(['name', 'hostname', 'username'])
def create_server():
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä"""
    data = request.get_json()
    server = Server.from_dict(data)

    data_manager = registry.get('data_manager')
    servers = data_manager.load_servers()
    servers.append(server)
    data_manager.save_servers(servers)

    return jsonify(server.to_dict()), 201

@api_bp.route('/api/servers/<server_id>', methods=['PUT'])
@require_auth
@validate_json(['name', 'hostname'])
def update_server(server_id):
    """–û–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä"""
    # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    pass

@api_bp.route('/api/servers/<server_id>', methods=['DELETE'])
@require_auth
def delete_server(server_id):
    """–£–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–µ—Ä"""
    # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è
    pass
```

#### 2. SSH –æ–ø–µ—Ä–∞—Ü–∏–∏
```python
@api_bp.route('/api/servers/<server_id>/test', methods=['POST'])
@require_auth
@rate_limit(max_requests=5, window=60)
def test_connection(server_id):
    """–¢–µ—Å—Ç SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"""
    ssh_service = registry.get('ssh')

    try:
        result = ssh_service.execute_command(server_id, 'echo "OK"')
        return jsonify({
            'success': True,
            'message': 'Connection successful',
            'output': result['output']
        })
    except SSHConnectionError as e:
        return jsonify({
            'success': False,
            'message': str(e)
        }), 503

@api_bp.route('/api/servers/<server_id>/status', methods=['GET'])
@require_auth
def get_server_status(server_id):
    """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞"""
    ssh_service = registry.get('ssh')

    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
        result = ssh_service.execute_command(server_id, 'uptime')

        return jsonify({
            'status': 'connected',
            'uptime': result['output']
        })
    except:
        return jsonify({'status': 'disconnected'})
```

#### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
```python
@api_bp.route('/api/monitoring/network/<server_id>', methods=['GET'])
@require_auth
@rate_limit(max_requests=10, window=60)
def get_network_stats(server_id):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–µ—Ç–µ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
    ssh_service = registry.get('ssh')
    stats = ssh_service.get_network_stats(server_id)
    return jsonify(stats)

@api_bp.route('/api/monitoring/firewall/<server_id>', methods=['GET'])
@require_auth
def get_firewall_status(server_id):
    """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å firewall"""
    ssh_service = registry.get('ssh')
    status = ssh_service.check_firewall_status(server_id)
    return jsonify(status)

@api_bp.route('/api/monitoring/services/<server_id>', methods=['GET'])
@require_auth
def get_services_status(server_id):
    """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤"""
    services = request.args.getlist('service')
    ssh_service = registry.get('ssh')

    results = {}
    for service in services:
        results[service] = ssh_service.get_service_status(server_id, service)

    return jsonify(results)

@api_bp.route('/api/monitoring/security/<server_id>', methods=['GET'])
@require_auth
def get_security_events(server_id):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–æ–±—ã—Ç–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (auth.log)"""
    ssh_service = registry.get('ssh')
    result = ssh_service.execute_command(
        server_id,
        "sudo tail -100 /var/log/auth.log | grep -i 'failed\\|accepted'"
    )
    return jsonify({'events': result['output'].split('\n')})
```

#### 4. EventSource (Server-Sent Events)
```python
@api_bp.route('/api/monitoring/install/<server_id>')
@require_auth
def install_monitoring_stream(server_id):
    """
    –£—Å—Ç–∞–Ω–æ–≤–∫–∞ monitoring —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º —á–µ—Ä–µ–∑ EventSource
    """
    def generate():
        ssh_service = registry.get('ssh')

        # –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        yield f"data: {json.dumps({'step': 1, 'message': 'Checking dependencies...'})}\n\n"

        # –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤
        yield f"data: {json.dumps({'step': 2, 'message': 'Installing packages...'})}\n\n"
        result = ssh_service.execute_command(
            server_id,
            'sudo apt-get update && sudo apt-get install -y iftop htop'
        )

        # –®–∞–≥ 3: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        yield f"data: {json.dumps({'step': 3, 'message': 'Configuring...'})}\n\n"

        # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
        yield f"data: {json.dumps({'step': 4, 'message': 'Done!', 'success': True})}\n\n"

    return Response(generate(), mimetype='text/event-stream')
```

#### 5. –£—Ç–∏–ª–∏—Ç—ã
```python
@api_bp.route('/api/ip-check', methods=['POST'])
@require_auth
@rate_limit(max_requests=20, window=60)
def check_ip():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ IP –∞–¥—Ä–µ—Å–∞"""
    data = request.get_json()
    ip = data.get('ip')

    api_service = registry.get('api')
    info = api_service.check_ip(ip)

    return jsonify(info)

@api_bp.route('/api/dns-test', methods=['POST'])
@require_auth
def dns_leak_test():
    """DNS leak test"""
    # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è DNS —Ç–µ—Å—Ç–∞
    pass

@api_bp.route('/api/snapshot/save', methods=['POST'])
@require_auth
def save_snapshot():
    """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ PNG —Å–Ω–∏–º–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
    data = request.get_json()
    image_data = data.get('image')  # Base64

    # –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Downloads
    downloads_dir = os.path.join(os.path.expanduser("~"), "Downloads")
    filename = f"vpn_stats_{datetime.now().strftime('%Y%m%d_%H%M%S')}.png"
    filepath = os.path.join(downloads_dir, filename)

    # –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ base64
    img_bytes = base64.b64decode(image_data.split(',')[1])
    with open(filepath, 'wb') as f:
        f.write(img_bytes)

    return jsonify({
        'success': True,
        'path': filepath
    })
```

---

## üé® Templates (Jinja2)

### **templates/layout.html** - –ë–∞–∑–æ–≤—ã–π layout

```html
<!DOCTYPE html>
<html lang="{{ get_locale() }}">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}VPN Server Manager{% endblock %}</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                VPN Manager v{{ app_info.version }}
            </a>

            <!-- Language Selector -->
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                        {{ _('Language') }}
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="?lang=ru">–†—É—Å—Å–∫–∏–π</a></li>
                        <li><a class="dropdown-item" href="?lang=en">English</a></li>
                        <li><a class="dropdown-item" href="?lang=zh">‰∏≠Êñá</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Content -->
    <div class="container mt-4">
        {% block content %}{% endblock %}
    </div>

    <!-- Footer -->
    <footer class="footer mt-5 py-3 bg-light">
        <div class="container text-center">
            <span class="text-muted">
                VPN Server Manager v{{ app_info.version }} |
                {{ app_info.developer }} |
                {{ server_info.url }}
            </span>
        </div>
    </footer>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    {% block scripts %}{% endblock %}
</body>
</html>
```

---

## üõ°Ô∏è Utilities (–î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã)

### **app/utils/decorators.py**

```python
def require_auth(f):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ PIN"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not session.get('authenticated'):
            if request.is_json:
                return jsonify({'error': 'Authentication required'}), 401
            return redirect(url_for('main.index_locked'))
        return f(*args, **kwargs)
    return decorated_function

def require_pin(f):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ PIN –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        data = request.get_json() if request.is_json else request.form
        pin = data.get('pin')

        if not pin or pin != current_app.config['DEFAULT_PIN']:
            return jsonify({'error': 'Invalid PIN'}), 401

        return f(*args, **kwargs)
    return decorated_function

def rate_limit(max_requests: int = 10, window: int = 60):
    """Rate limiting (Token Bucket)"""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            from .rate_limiter import RateLimiter

            limiter = RateLimiter(max_requests, window)
            client_id = request.remote_addr

            if not limiter.allow_request(client_id):
                return jsonify({
                    'error': 'Rate limit exceeded',
                    'retry_after': window
                }), 429

            return f(*args, **kwargs)
        return decorated_function
    return decorator

def validate_json(required_fields: list):
    """–í–∞–ª–∏–¥–∞—Ü–∏—è JSON –¥–∞–Ω–Ω—ã—Ö"""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            if not request.is_json:
                return jsonify({'error': 'Content-Type must be application/json'}), 400

            data = request.get_json()
            missing = [field for field in required_fields if field not in data]

            if missing:
                return jsonify({
                    'error': f'Missing required fields: {", ".join(missing)}'
                }), 400

            return f(*args, **kwargs)
        return decorated_function
    return decorator

def handle_errors(f):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        try:
            return f(*args, **kwargs)
        except AppException as e:
            if request.is_json:
                return jsonify({'error': str(e)}), e.status_code
            flash(str(e), 'error')
            return redirect(url_for('main.index'))
        except Exception as e:
            current_app.logger.error(f"Unhandled error: {e}")
            if request.is_json:
                return jsonify({'error': 'Internal server error'}), 500
            flash('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error')
            return redirect(url_for('main.index'))
    return decorated_function
```

---

## üìä Models (–ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö)

### **app/models/server.py**

```python
from dataclasses import dataclass, field
from typing import Optional
import uuid
from datetime import datetime

@dataclass
class Server:
    """–ú–æ–¥–µ–ª—å VPN —Å–µ—Ä–≤–µ—Ä–∞"""
    name: str
    hostname: str
    username: str
    password: Optional[str] = None
    ssh_key_path: Optional[str] = None
    ssh_port: int = 22
    id: str = field(default_factory=lambda: str(uuid.uuid4()))
    created_at: str = field(default_factory=lambda: datetime.now().isoformat())
    updated_at: str = field(default_factory=lambda: datetime.now().isoformat())
    status: str = 'unknown'
    notes: str = ''

    def to_dict(self) -> dict:
        """–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —Å–ª–æ–≤–∞—Ä—å"""
        return {
            'id': self.id,
            'name': self.name,
            'hostname': self.hostname,
            'username': self.username,
            'password': self.password,
            'ssh_key_path': self.ssh_key_path,
            'ssh_port': self.ssh_port,
            'created_at': self.created_at,
            'updated_at': self.updated_at,
            'status': self.status,
            'notes': self.notes
        }

    @classmethod
    def from_dict(cls, data: dict) -> 'Server':
        """–°–æ–∑–¥–∞–Ω–∏–µ –∏–∑ —Å–ª–æ–≤–∞—Ä—è"""
        return cls(
            id=data.get('id', str(uuid.uuid4())),
            name=data['name'],
            hostname=data['hostname'],
            username=data['username'],
            password=data.get('password'),
            ssh_key_path=data.get('ssh_key_path'),
            ssh_port=data.get('ssh_port', 22),
            created_at=data.get('created_at', datetime.now().isoformat()),
            updated_at=data.get('updated_at', datetime.now().isoformat()),
            status=data.get('status', 'unknown'),
            notes=data.get('notes', '')
        )

    def validate(self) -> bool:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö"""
        if not self.name or not self.hostname or not self.username:
            return False
        if not self.password and not self.ssh_key_path:
            return False
        if self.ssh_port < 1 or self.ssh_port > 65535:
            return False
        return True
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:

1. **PIN-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**
   - –°–µ—Å—Å–∏–æ–Ω–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
   - PIN —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `.env` –∏–ª–∏ `config.json`
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `@require_auth`

2. **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö**
   - Fernet (AES-128 + HMAC-SHA256)
   - –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π —Å–µ—Ä–≤–µ—Ä–æ–≤
   - –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –¥–∞–Ω–Ω—ã—Ö (`.enc`)

3. **Rate Limiting**
   - Token Bucket –∞–ª–≥–æ—Ä–∏—Ç–º
   - –õ–∏–º–∏—Ç—ã –Ω–∞ API endpoints
   - –ó–∞—â–∏—Ç–∞ –æ—Ç brute-force

4. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**
   - JSON Schema –≤–∞–ª–∏–¥–∞—Ü–∏—è
   - –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - –ó–∞—â–∏—Ç–∞ –æ—Ç SQL injection (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SQL)

5. **CSRF –∑–∞—â–∏—Ç–∞**
   - Flask-WTF CSRF —Ç–æ–∫–µ–Ω—ã
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ Origin header

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### **tests/conftest.py** - Pytest fixtures

```python
import pytest
from app import create_app
from app.services import registry

@pytest.fixture
def app():
    """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    app = create_app('testing')
    return app

@pytest.fixture
def client(app):
    """Flask test client"""
    return app.test_client()

@pytest.fixture
def runner(app):
    """Flask CLI runner"""
    return app.test_cli_runner()

@pytest.fixture
def authenticated_client(client):
    """–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç"""
    with client.session_transaction() as sess:
        sess['authenticated'] = True
    return client
```

### –ü—Ä–∏–º–µ—Ä —Ç–µ—Å—Ç–∞:

```python
def test_get_servers(authenticated_client):
    """–¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤"""
    response = authenticated_client.get('/api/servers')
    assert response.status_code == 200
    assert response.is_json
    data = response.get_json()
    assert isinstance(data, list)
```

---

## üê≥ Docker

### **Dockerfile**

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
COPY . .

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
ENV FLASK_APP=run.py
ENV PYTHONUNBUFFERED=1

EXPOSE 5000

CMD ["python", "run.py"]
```

### **docker-compose.yml**

```yaml
version: '3.8'

services:
  vpn-manager:
    build: .
    ports:
      - "5000:5000"
    volumes:
      - ./data:/app/data
      - ./.env:/app/.env
    environment:
      - FLASK_ENV=production
    restart: unless-stopped
```

---

## üìù –û—Å–Ω–æ–≤–Ω—ã–µ workflow

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞

```
User ‚Üí /add_server (form) ‚Üí POST /api/servers
  ‚Üí validate_json(['name', 'hostname', 'username'])
  ‚Üí Server.from_dict(data)
  ‚Üí DataManagerService.save_servers()
  ‚Üí CryptoService.encrypt_file()
  ‚Üí Response 201
```

### 2. –¢–µ—Å—Ç SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

```
User ‚Üí Click "Test" ‚Üí POST /api/servers/{id}/test
  ‚Üí SSHService.get_or_create_connection()
  ‚Üí paramiko.SSHClient.connect()
  ‚Üí execute_command('echo OK')
  ‚Üí Response {success: true}
```

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ä–≤–µ—Ä–∞

```
User ‚Üí /monitoring ‚Üí GET /api/monitoring/network/{id}
  ‚Üí SSHService.execute_command('cat /proc/net/dev')
  ‚Üí Parse output
  ‚Üí Response {interfaces: [...]}
```

### 4. –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ PNG

```
User ‚Üí Click "Save as PNG" ‚Üí JavaScript html2canvas
  ‚Üí Canvas to Base64
  ‚Üí POST /api/snapshot/save {image: base64}
  ‚Üí base64.b64decode()
  ‚Üí Save to ~/Downloads/vpn_stats_{timestamp}.png
  ‚Üí Response {success: true, path: ...}
```

---

## üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

1. **Multi-threading Flask**
   ```python
   app.run(threaded=True)  # –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
   ```

2. **SSH Connection Pooling**
   - –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (keepalive ping)
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ idle —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

3. **Lazy Loading**
   - –°–µ—Ä–≤–∏—Å—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏
   - –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é

4. **Caching**
   - –î–µ–∫–æ—Ä–∞—Ç–æ—Ä `@cache_response`
   - In-memory –∫–µ—à –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

- **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞**: `ArchitecturalRules.md`
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞**: `PROJECT_DOCUMENTATION.md`
- **–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏**: `MIGRATION_GUIDE.md`
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: `SECURITY.md`, `SECURITY_AUDIT_REPORT.md`
- **–†–µ–ª–∏–∑ –≥–∞–π–¥**: `docs/release_guide.md`

---

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

VPN Server Manager v4.0.9 - —ç—Ç–æ –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å:
- –ú–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π (Application Factory, Service Layer, Blueprints)
- –í—ã—Å–æ–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é (multi-threading, connection pooling)
- –ù–∞–¥–µ–∂–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é (—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ, PIN, rate limiting)
- –ö—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ—Å—Ç—å—é (macOS, Windows, Linux, Docker)
- –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –ø—Ä–∞–∫—Ç–∏–∫–∞–º–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (DI, decorators, type hints)
- Comprehensive testing (pytest, coverage)
- –ü–æ–ª–Ω–æ–π –∏–Ω—Ç–µ—Ä–Ω–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–µ–π (ru, en, zh)

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –∏ –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π.
