#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—Ç–∫–∞—Ç–∞ –∫ —Ä–µ–∑–µ—Ä–≤–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   ./rollback.sh [backup-branch-name]
#   ./rollback.sh -y [backup-branch-name]   # –Ω–µ –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã (non-interactive)

set -euo pipefail

echo "üîÑ –°–∫—Ä–∏–ø—Ç –æ—Ç–∫–∞—Ç–∞ –∫ —Ä–µ–∑–µ—Ä–≤–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é"
echo "========================================"

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
AUTO_YES=false
BACKUP_BRANCH_DEFAULT="backup/current-state-20250805-103439"
USER_BRANCH=""

# –†–∞–∑–±–æ—Ä –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
for arg in "$@"; do
  case "$arg" in
    -y|--yes)
      AUTO_YES=true
      shift
      ;;
    *)
      USER_BRANCH="$arg"
      shift || true
      ;;
  esac
done

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –≤–µ—Ç–∫—É
BACKUP_BRANCH="${USER_BRANCH:-$BACKUP_BRANCH_DEFAULT}"

echo "üìã –†–µ–∑–µ—Ä–≤–Ω–∞—è –≤–µ—Ç–∫–∞: $BACKUP_BRANCH"

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –º—ã –≤ git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  echo "‚ùå –û—à–∏–±–∫–∞: –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ —è–≤–ª—è–µ—Ç—Å—è git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º"
  exit 1
fi

# –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω—ã–µ –≤–µ—Ç–∫–∏
echo "üåê –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω—ã–µ –≤–µ—Ç–∫–∏..."
git fetch --all --prune

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –≤–µ—Ç–∫–∏
if ! git show-ref --verify --quiet "refs/remotes/origin/${BACKUP_BRANCH}"; then
    echo "‚ùå –û—à–∏–±–∫–∞: –†–µ–∑–µ—Ä–≤–Ω–∞—è –≤–µ—Ç–∫–∞ ${BACKUP_BRANCH} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ origin"
    echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –≤–µ—Ç–∫–∏:" && git branch -r | grep backup/ || echo "–ù–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –≤–µ—Ç–æ–∫"
    exit 1
fi

# –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –æ—Ç–∫–∞—Ç–∏—Ç –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è!"
echo "–¢–µ–∫—É—â–∏–µ –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ stash."

if [ "$AUTO_YES" = false ]; then
  read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/N): " -n 1 -r || true
  echo
  if [[ ! ${REPLY:-} =~ ^[Yy]$ ]]; then
      echo "‚ùå –û—Ç–∫–∞—Ç –æ—Ç–º–µ–Ω–µ–Ω"
      exit 1
  fi
fi

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
if ! git diff-index --quiet HEAD --; then
    echo "üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ stash..."
    git stash push -m "Auto-stash before rollback $(date '+%Y-%m-%d %H:%M:%S')"
fi

# –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
echo "üîÑ –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –≤–µ—Ç–∫—É..."
git checkout "$BACKUP_BRANCH"

echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –≤–µ—Ç–∫—É..."
git pull --ff-only origin "$BACKUP_BRANCH"

echo "‚úÖ –û—Ç–∫–∞—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
echo "üìã –¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $(git branch --show-current)"
echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç:" && git log --oneline -1 | cat

echo ""
echo "üí° –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "  - git log --oneline -10 | cat   # –ò—Å—Ç–æ—Ä–∏—è –∫–æ–º–º–∏—Ç–æ–≤"
echo "  - git stash list | cat          # –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
echo "  - git stash pop                 # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
echo "  - git branch -a | cat           # –í—Å–µ –≤–µ—Ç–∫–∏" 