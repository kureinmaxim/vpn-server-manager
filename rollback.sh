#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—Ç–∫–∞—Ç–∞ –∫ —Ä–µ–∑–µ—Ä–≤–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./rollback.sh [backup-branch-name]

set -e

echo "üîÑ –°–∫—Ä–∏–ø—Ç –æ—Ç–∫–∞—Ç–∞ –∫ —Ä–µ–∑–µ—Ä–≤–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é"
echo "========================================"

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –≤–µ—Ç–∫—É
if [ -n "$1" ]; then
    BACKUP_BRANCH="$1"
else
    BACKUP_BRANCH="backup/current-state-20250805-103439"
fi

echo "üìã –†–µ–∑–µ—Ä–≤–Ω–∞—è –≤–µ—Ç–∫–∞: $BACKUP_BRANCH"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –≤–µ—Ç–∫–∏
if ! git show-ref --verify --quiet refs/remotes/origin/$BACKUP_BRANCH; then
    echo "‚ùå –û—à–∏–±–∫–∞: –†–µ–∑–µ—Ä–≤–Ω–∞—è –≤–µ—Ç–∫–∞ $BACKUP_BRANCH –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –≤–µ—Ç–∫–∏:"
    git branch -r | grep backup/ || echo "–ù–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –≤–µ—Ç–æ–∫"
    exit 1
fi

echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –æ—Ç–∫–∞—Ç–∏—Ç –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è!"
echo "–¢–µ–∫—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã."
read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/N): " -n 1 -r
echo

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "‚ùå –û—Ç–∫–∞—Ç –æ—Ç–º–µ–Ω–µ–Ω"
    exit 1
fi

echo "üîÑ –í—ã–ø–æ–ª–Ω—è–µ–º –æ—Ç–∫–∞—Ç..."

# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ stash (–µ—Å–ª–∏ –µ—Å—Ç—å)
if ! git diff-index --quiet HEAD --; then
    echo "üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ stash..."
    git stash push -m "Auto-stash before rollback $(date)"
fi

# –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –≤–µ—Ç–∫—É
echo "üîÑ –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –≤–µ—Ç–∫—É..."
git checkout $BACKUP_BRANCH

# –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ç–∫—É
echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –≤–µ—Ç–∫—É..."
git pull origin $BACKUP_BRANCH

echo "‚úÖ –û—Ç–∫–∞—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
echo "üìã –¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $(git branch --show-current)"
echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç: $(git log --oneline -1)"

echo ""
echo "üí° –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "  - git log --oneline -10  # –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∫–æ–º–º–∏—Ç–æ–≤"
echo "  - git stash list         # –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
echo "  - git stash pop          # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
echo "  - git branch -a          # –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –≤–µ—Ç–∫–∏" 