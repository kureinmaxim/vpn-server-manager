{% extends "layout.html" %}

{% block head %}
{{ super() }}
<!-- Monitoring CSS with cache buster -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/monitoring.css') }}?v=2.1">
{% endblock %}

{% block content %}
<div class="container-fluid mt-3 monitoring-page">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1>
                <i class="bi bi-bar-chart-line"></i> {{ _('–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥') }}
            </h1>
            <p class="text-muted mb-0 small">
                <strong>{{ server.name }}</strong> - {{ server.ip_address }}
                {% if server.provider %}<span class="badge bg-secondary">{{ server.provider }}</span>{% endif %}
            </p>
        </div>
        <div>
            <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left"></i> {{ _('–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É') }}
            </a>
        </div>
    </div>

    <!-- Loading Indicator (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É, —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS) -->
    <div id="initial-loading" class="text-center py-5">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">{{ _('–ó–∞–≥—Ä—É–∑–∫–∞...') }}</span>
        </div>
        <h5 class="text-muted">{{ _('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞...') }}</h5>
        <p class="small text-muted">{{ _('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...') }}</p>
    </div>

    <!-- Installation Panel (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ) -->
    <div id="installation-panel" class="installation-panel" style="display: none;">
        <div class="install-card">
            <div class="install-header">
                <h3>
                    <i class="bi bi-box-seam"></i> {{ _('–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞') }}
                </h3>
                <p>{{ _('–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ —ç—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ') }}</p>
            </div>
            
            <div class="install-body">
                <div class="install-features">
                    <h4>{{ _('–ß—Ç–æ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ:') }}</h4>
                    <ul>
                        <li>‚úÖ {{ _('vnstat - –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞') }}</li>
                        <li>‚úÖ {{ _('jq - –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ JSON') }}</li>
                        <li>‚úÖ {{ _('net-tools - –¥–ª—è —Å–µ—Ç–µ–≤–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏') }}</li>
                        <li>‚ö†Ô∏è {{ _('ufw - —Ç–æ–ª—å–∫–æ –ø–∞–∫–µ—Ç (–ù–ï –í–ö–õ–Æ–ß–ê–ï–¢–°–Ø!)') }}</li>
                    </ul>
                    <p class="mt-2 text-muted small">
                        <i class="bi bi-info-circle"></i> {{ _('–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–π–º–µ—Ç 1-2 –º–∏–Ω—É—Ç—ã') }}
                    </p>
                </div>
                
                <button id="install-btn" class="btn btn-primary btn-lg">
                    <i class="bi bi-download"></i> {{ _('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥') }}
                </button>
                
                <!-- Progress section -->
                <div id="install-progress" style="display: none;">
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progress-bar"></div>
                        <span class="progress-text" id="progress-text">0%</span>
                    </div>
                    
                    <div class="install-logs" id="install-logs">
                        <!-- –õ–æ–≥–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ -->
                    </div>
                    
                    <!-- Cancel button -->
                    <button id="cancel-install-btn" class="btn btn-danger btn-block mt-3" style="display: none;">
                        <i class="bi bi-x-circle"></i> {{ _('–û—Ç–º–µ–Ω–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É') }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Container (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏) -->
    <div id="stats-container" style="display: none;">
        
        <!-- Settings button removed - not needed -->
        <!--
        <div class="monitoring-controls mb-3" style="display: none;" id="monitoring-controls">
            <button id="show-settings-btn" class="btn btn-secondary btn-sm">
                <i class="bi bi-gear"></i> {{ _('–ù–∞—Å—Ç—Ä–æ–π–∫–∏') }}
            </button>
        </div>
        -->

    <!-- Connection Error Alert -->
    <div id="connection-error-alert" class="alert alert-danger d-none mb-4" role="alert">
        <div class="d-flex align-items-start">
            <div class="me-3" style="font-size: 2rem;">‚ö†Ô∏è</div>
            <div class="flex-grow-1">
                <h5 class="alert-heading mb-2">
                    <i class="bi bi-exclamation-octagon"></i> {{ _('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É') }}
                </h5>
                <p class="mb-2" id="connection-error-message"></p>
                <div id="connection-error-details" class="small text-muted mb-2"></div>
                <div class="mt-3">
                    <h6>{{ _('–ß—Ç–æ –¥–µ–ª–∞—Ç—å:') }}</h6>
                    <ul id="connection-error-solutions" class="small mb-0"></ul>
                </div>
                <div class="mt-3">
                    <a href="{{ url_for('main.edit_server', server_id=server.id) }}" class="btn btn-sm btn-primary">
                        <i class="bi bi-pencil"></i> {{ _('–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞') }}
                    </a>
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise"></i> {{ _('–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É') }}
                    </button>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>

    <!-- Tools Check Alert -->
    <div id="tools-alert" class="alert alert-warning d-none mb-4" role="alert">
        <div class="d-flex align-items-start">
            <div class="me-3" style="font-size: 2rem;"><i class="bi bi-tools"></i></div>
            <div class="flex-grow-1">
                <h5 class="alert-heading mb-2">
                    <i class="bi bi-exclamation-triangle"></i> {{ _('–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã') }}
                </h5>
                <p class="mb-2" id="tools-summary"></p>
                
                <div id="missing-tools-list" class="mb-3"></div>
                
                <div id="install-all-section" class="d-none">
                    <h6>{{ _('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π:') }}</h6>
                    <div class="input-group">
                        <input type="text" class="form-control font-monospace" id="install-all-cmd" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyCommand('install-all-cmd')">
                            <i class="bi bi-clipboard"></i> {{ _('–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å') }}
                        </button>
                    </div>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>

    <!-- Network Traffic -->
    <div class="network-traffic card mb-4">
        <div class="card-body">
            <h3><i class="bi bi-graph-up"></i> {{ _('–°–µ—Ç–µ–≤–æ–π —Ç—Ä–∞—Ñ–∏–∫') }}</h3>
            <div class="mb-2" style="font-size: 0.85rem; color: #6c757d;">
                <span id="monitored-interfaces">üîç {{ _('–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—Å–µ—Ö —Å–µ—Ç–µ–≤—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤') }}</span>
            </div>
            <div class="traffic-stats">
                <div class="stat">
                    <span class="label">‚Üì {{ _('–ó–∞–≥—Ä—É–∑–∫–∞:') }}</span>
                    <span class="value" id="rx-speed">0 MB/s</span>
                    <span class="peak">{{ _('–ü–∏–∫:') }} <span id="rx-peak">0</span> MB/s</span>
                </div>
                <div class="stat">
                    <span class="label">‚Üë {{ _('–û—Ç–¥–∞—á–∞:') }}</span>
                    <span class="value" id="tx-speed">0 MB/s</span>
                    <span class="peak">{{ _('–ü–∏–∫:') }} <span id="tx-peak">0</span> MB/s</span>
                </div>
            </div>
            <div class="daily-stats">
                <p>üìà {{ _('–ó–∞ 24 —á–∞—Å–∞:') }} ‚Üì <span id="daily-rx">0 GB</span> ‚Üë <span id="daily-tx">0 GB</span></p>
            </div>
        </div>
    </div>

    <!-- Firewall Status -->
    <div class="firewall-status card mb-4">
        <div class="card-body">
            <h3><i class="bi bi-shield-check"></i> {{ _('–°—Ç–∞—Ç—É—Å –±—Ä–∞–Ω–¥–º–∞—É—ç—Ä–∞') }}</h3>
            <div class="firewall-info">
                <div class="status-badge">
                    <span id="fw-status">{{ _('–ó–∞–≥—Ä—É–∑–∫–∞...') }}</span>
                </div>
                <div class="fw-details">
                    <p><strong>{{ _('–û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ—Ä—Ç—ã:') }}</strong> <span id="open-ports">-</span></p>
                    <p><strong>{{ _('–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –∑–∞ 24—á:') }}</strong> <span id="blocked-count">0</span> {{ _('–ø–æ–ø—ã—Ç–æ–∫') }}</p>
                    <p class="last-block">
                        <strong>{{ _('–ü–æ—Å–ª–µ–¥–Ω–∏–π –±–ª–æ–∫:') }}</strong> 
                        <span id="last-blocked-ip">-</span> 
                        ({{ _('–ø–æ—Ä—Ç:') }} <span id="last-blocked-port">-</span>)
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Services -->
    <div class="active-services card mb-4">
        <div class="card-body">
            <h3><i class="bi bi-gear"></i> {{ _('–°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã') }}</h3>
            <div id="services-list" class="services-grid">
                <div class="text-muted">{{ _('–ó–∞–≥—Ä—É–∑–∫–∞...') }}</div>
            </div>
        </div>
    </div>

    <!-- Security Events -->
    <div class="security-events card mb-4">
        <div class="card-body">
            <h3><i class="bi bi-shield-exclamation"></i> {{ _('–°–æ–±—ã—Ç–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (24—á)') }}</h3>
            <div class="events-grid">
                <div class="event-card">
                    <div class="event-icon">‚ö†Ô∏è</div>
                    <div class="event-content">
                        <div class="event-value" id="ssh-failures">0</div>
                        <div class="event-label">{{ _('–ù–µ—É–¥–∞—á–Ω—ã–µ SSH –ø–æ–ø—ã—Ç–∫–∏') }}</div>
                    </div>
                </div>
                
                <div class="event-card">
                    <div class="event-icon">üîÑ</div>
                    <div class="event-content">
                        <div class="event-value" id="security-updates">0</div>
                        <div class="event-label">{{ _('–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏') }}</div>
                    </div>
                </div>
                
                <div class="event-card">
                    <div class="event-icon">üîå</div>
                    <div class="event-content">
                        <div class="event-value" id="new-ports">0</div>
                        <div class="event-label">{{ _('–ù–æ–≤—ã–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ—Ä—Ç—ã') }}</div>
                    </div>
                </div>
            </div>
            
            <div class="top-threats" id="top-threats">
                <!-- –¢–æ–ø —É–≥—Ä–æ–∑ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            
            <div class="last-update">
                {{ _('–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã:') }} <span id="days-since-update">-</span> {{ _('–¥–Ω–µ–π –Ω–∞–∑–∞–¥') }}
            </div>
        </div>
    </div>

    <!-- Mini Charts -->
    <div class="mini-charts card mb-4">
        <div class="card-body">
            <h3><i class="bi bi-graph-up-arrow"></i> {{ _('–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (60 –º–∏–Ω)') }}</h3>
            <div class="charts-container">
                <div class="chart-card card">
                    <div class="card-body">
                        <h4>{{ _('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU') }}</h4>
                        <div class="chart-wrapper">
                            <canvas id="cpu-chart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="chart-card card">
                    <div class="card-body">
                        <h4>{{ _('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏') }}</h4>
                        <div class="chart-wrapper">
                            <canvas id="memory-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- Delete Monitoring Button -->
        <div class="mt-4 text-end">
            <button class="btn btn-outline-danger" id="uninstall-btn-main">
                <i class="bi bi-trash"></i> {{ _('–£–¥–∞–ª–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥') }}
            </button>
        </div>

    </div> <!-- End #stats-container -->
</div>

<!-- Modal –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div class="modal fade" id="uninstallModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚ö†Ô∏è {{ _('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>{{ _('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞?') }}</p>
                <p class="text-muted">{{ _('–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç:') }}</p>
                <ul class="text-muted">
                    <li>{{ _('–§–∞–π–ª—ã –∏—Å—Ç–æ—Ä–∏–∏ –º–µ—Ç—Ä–∏–∫') }}</li>
                    <li>{{ _('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞') }}</li>
                </ul>
                <p class="text-danger"><strong>{{ _('–í–Ω–∏–º–∞–Ω–∏–µ:') }}</strong> {{ _('–ò—Å—Ç–æ—Ä–∏—è –º–µ—Ç—Ä–∏–∫ –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω–∞!') }}</p>
                
                <!-- Progress section –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è -->
                <div id="uninstall-progress" style="display: none;">
                    <div class="progress-bar-container">
                        <div class="progress-bar progress-bar-danger" id="uninstall-progress-bar"></div>
                        <span class="progress-text" id="uninstall-progress-text">0%</span>
                    </div>
                    <div class="install-logs" id="uninstall-logs"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancel-uninstall-btn">
                    {{ _('–û—Ç–º–µ–Ω–∞') }}
                </button>
                <button type="button" class="btn btn-danger" id="confirm-uninstall-btn">
                    <i class="bi bi-trash"></i> {{ _('–î–∞, —É–¥–∞–ª–∏—Ç—å') }}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Settings Panel removed - delete button now on main page -->

<!-- Styles moved to static/css/monitoring.css -->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Debug output - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
console.log('‚úÖ Monitoring script loaded');
console.log('üìç Current URL:', window.location.href);
console.log('üÜî Server ID:', '{{ server.id }}');
console.log('üì° Server IP:', '{{ server.ip_address }}');

const serverId = '{{ server.id }}';
let rxPeak = 0;
let txPeak = 0;
let cpuChart, memoryChart;

// Network Traffic Update
async function updateNetworkStats() {
    try {
        console.log('üìä Fetching network stats...');
        const response = await fetch(`/api/monitoring/${serverId}/network-stats`, {
            signal: AbortSignal.timeout(25000) // Timeout 25 —Å–µ–∫—É–Ω–¥
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        console.log('üìà Network stats:', data);
        
        if (data.success) {
            errorCount = 0; // –°–±—Ä–æ—Å –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
            
            const stats = data.data;
            document.getElementById('rx-speed').textContent = `${stats.current.download} MB/s`;
            document.getElementById('tx-speed').textContent = `${stats.current.upload} MB/s`;
            
            if (parseFloat(stats.current.download) > rxPeak) {
                rxPeak = parseFloat(stats.current.download);
                document.getElementById('rx-peak').textContent = rxPeak.toFixed(2);
            }
            if (parseFloat(stats.current.upload) > txPeak) {
                txPeak = parseFloat(stats.current.upload);
                document.getElementById('tx-peak').textContent = txPeak.toFixed(2);
            }
            
            document.getElementById('daily-rx').textContent = stats.daily.download;
            document.getElementById('daily-tx').textContent = stats.daily.upload;
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–º—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤
            if (stats.interfaces && stats.interfaces.length > 0) {
                const interfacesList = stats.interfaces.join(', ');
                document.getElementById('monitored-interfaces').innerHTML = 
                    `üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: <strong>${interfacesList}</strong> (${stats.interfaces.length} –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å${stats.interfaces.length > 1 ? '–æ–≤' : ''})`;
            } else if (stats.interface) {
                document.getElementById('monitored-interfaces').textContent = 
                    `üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: ${stats.interface}`;
            }
        } else {
            handleError(data.error || 'Failed to load network stats', 'NetworkStats');
        }
    } catch (error) {
        console.error('Error fetching network stats:', error);
        handleError(error.message, 'NetworkStats');
    }
}

// Firewall Status Update
async function updateFirewallStatus() {
    try {
        const response = await fetch(`/api/monitoring/${serverId}/firewall-stats`);
        const data = await response.json();
        
        if (data.success) {
            const stats = data.data;
            const statusElement = document.getElementById('fw-status');
            if (stats.status && stats.status.toLowerCase() === 'active') {
                statusElement.textContent = '‚úÖ Active';
                statusElement.className = 'status-active';
            } else {
                statusElement.textContent = '‚ùå Inactive';
                statusElement.className = 'status-inactive';
            }
            
            document.getElementById('open-ports').textContent = stats.open_ports || 'none';
            document.getElementById('blocked-count').textContent = stats.blocked_24h || 0;
            document.getElementById('last-blocked-ip').textContent = stats.last_blocked?.ip || 'none';
            document.getElementById('last-blocked-port').textContent = stats.last_blocked?.port || '-';
        }
    } catch (error) {
        console.error('Error fetching firewall stats:', error);
    }
}

// Services Status Update
async function updateServicesStatus() {
    try {
        const response = await fetch(`/api/monitoring/${serverId}/services-stats`);
        const data = await response.json();
        
        if (data.success) {
            const services = data.data;
            const container = document.getElementById('services-list');
            container.innerHTML = '';
            
            services.forEach(service => {
                const serviceEl = document.createElement('div');
                serviceEl.className = `service-item ${service.status}`;
                
                const statusIcon = service.status === 'active' ? '‚úÖ' : '‚ùå';
                const statusText = service.status === 'active' ? 'active' : 'inactive';
                
                serviceEl.innerHTML = `
                    <div class="service-header">
                        <span class="service-name">${service.name}</span>
                        <span class="service-status">${statusIcon} ${statusText}</span>
                    </div>
                    <div class="service-uptime">${service.uptime || '-'}</div>
                `;
                
                container.appendChild(serviceEl);
            });
        }
    } catch (error) {
        console.error('Error fetching services stats:', error);
    }
}

// Security Events Update
async function updateSecurityEvents() {
    try {
        const response = await fetch(`/api/monitoring/${serverId}/security-events`);
        const data = await response.json();
        
        if (data.success) {
            const stats = data.data;
            document.getElementById('ssh-failures').textContent = stats.ssh_failures_24h || 0;
            document.getElementById('security-updates').textContent = stats.security_updates_available || 0;
            document.getElementById('new-ports').textContent = stats.new_open_ports || 0;
            document.getElementById('days-since-update').textContent = stats.days_since_update || '-';
            
            const sshCard = document.getElementById('ssh-failures').closest('.event-card');
            if (stats.ssh_failures_24h > 50) {
                sshCard.classList.add('warning');
            }
            
            const threatsContainer = document.getElementById('top-threats');
            if (stats.top_failed_ips && stats.top_failed_ips.length > 0) {
                threatsContainer.innerHTML = '<h4>{{ _("Top –∞—Ç–∞–∫—É—é—â–∏—Ö IP:") }}</h4>';
                stats.top_failed_ips.forEach(item => {
                    threatsContainer.innerHTML += `
                        <div class="threat-item">
                            <span class="threat-ip">${item.ip}</span>
                            <span class="threat-count">${item.count} {{ _("–ø–æ–ø—ã—Ç–æ–∫") }}</span>
                        </div>
                    `;
                });
            }
        }
    } catch (error) {
        console.error('Error fetching security events:', error);
    }
}

// Charts
function createCharts() {
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: { color: '#6c757d' },
                grid: { color: '#dee2e6' }
            },
            x: {
                ticks: { color: '#6c757d' },
                grid: { color: '#dee2e6' }
            }
        },
        plugins: {
            legend: { display: false }
        }
    };
    
    const cpuCtx = document.getElementById('cpu-chart').getContext('2d');
    cpuChart = new Chart(cpuCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'CPU %',
                data: [],
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: chartOptions
    });
    
    const memCtx = document.getElementById('memory-chart').getContext('2d');
    memoryChart = new Chart(memCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Memory %',
                data: [],
                borderColor: '#6610f2',
                backgroundColor: 'rgba(102, 16, 242, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: chartOptions
    });
}

async function updateCharts() {
    try {
        const response = await fetch(`/api/monitoring/${serverId}/metrics-history`);
        const data = await response.json();
        
        if (data.success) {
            const history = data.data;
            const labels = history.map((point, index) => {
                if (index % 10 === 0) {
                    const date = new Date(point.timestamp * 1000);
                    return date.getHours() + ':' + String(date.getMinutes()).padStart(2, '0');
                }
                return '';
            });
            
            cpuChart.data.labels = labels;
            cpuChart.data.datasets[0].data = history.map(p => p.cpu);
            cpuChart.update('none');
            
            memoryChart.data.labels = labels;
            memoryChart.data.datasets[0].data = history.map(p => p.memory);
            memoryChart.update('none');
        }
    } catch (error) {
        console.error('Error updating charts:', error);
    }
}

// Show connection error
function showConnectionError(errorType, errorMessage) {
    const alert = document.getElementById('connection-error-alert');
    const messageEl = document.getElementById('connection-error-message');
    const detailsEl = document.getElementById('connection-error-details');
    const solutionsEl = document.getElementById('connection-error-solutions');
    
    let message = '';
    let details = '';
    let solutions = [];
    
    if (errorType === 'timeout') {
        message = '{{ _("–ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –ø–æ SSH. –ü—Ä–µ–≤—ã—à–µ–Ω timeout –æ–∂–∏–¥–∞–Ω–∏—è.") }}';
        details = `{{ _("–°–µ—Ä–≤–µ—Ä:") }} {{ server.name }} ({{ server.ip_address }})`;
        solutions = [
            '{{ _("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –≤–∫–ª—é—á–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω") }}',
            '{{ _("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ SSH –ø–æ—Ä—Ç –æ—Ç–∫—Ä—ã—Ç (–æ–±—ã—á–Ω–æ 22)") }}',
            '{{ _("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å IP –∞–¥—Ä–µ—Å–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö") }}',
            '{{ _("–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –≤—Ä—É—á–Ω—É—é: ssh user@") }}{{ server.ip_address }}',
            '{{ _("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ firewall –Ω–∞ –≤–∞—à–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ") }}'
        ];
    } else if (errorType === 'auth') {
        message = '{{ _("–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ SSH") }}';
        details = '{{ _("–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å") }}';
        solutions = [
            '{{ _("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è SSH –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞") }}',
            '{{ _("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–æ–ª—å SSH –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞") }}',
            '{{ _("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–∞—Ä–æ–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ") }}'
        ];
    } else {
        message = '{{ _("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞") }}';
        details = errorMessage || '{{ _("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞") }}';
        solutions = [
            '{{ _("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É") }}',
            '{{ _("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏") }}',
            '{{ _("–°–º. logs/app.log –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏") }}'
        ];
    }
    
    messageEl.textContent = message;
    detailsEl.textContent = details;
    
    solutionsEl.innerHTML = '';
    solutions.forEach(solution => {
        const li = document.createElement('li');
        li.textContent = solution;
        solutionsEl.appendChild(li);
    });
    
    alert.classList.remove('d-none');
}

// Check Required Tools
async function checkRequiredTools() {
    try {
        console.log('üîß Checking required tools for server:', serverId);
        const response = await fetch(`/api/monitoring/${serverId}/check-tools`);
        console.log('üì• Check tools response status:', response.status);
        const data = await response.json();
        console.log('üìä Check tools data:', data);
        
        if (data.success && data.data) {
            const toolsData = data.data;
            
            // –ï—Å–ª–∏ –≤—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ, —Å–∫—Ä—ã–≤–∞–µ–º –∞–ª–µ—Ä—Ç
            if (toolsData.all_ok) {
                document.getElementById('tools-alert').classList.add('d-none');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–ª–µ—Ä—Ç
            document.getElementById('tools-alert').classList.remove('d-none');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º summary
            const summary = `{{ _('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ:') }} ${toolsData.installed}/${toolsData.total}. ` +
                          `{{ _('–ù–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö —É—Ç–∏–ª–∏—Ç:') }} ${toolsData.missing_count}`;
            document.getElementById('tools-summary').textContent = summary;
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö —É—Ç–∏–ª–∏—Ç
            const missingList = document.getElementById('missing-tools-list');
            missingList.innerHTML = '';
            
            if (toolsData.missing && toolsData.missing.length > 0) {
                toolsData.missing.forEach(tool => {
                    const toolDiv = document.createElement('div');
                    toolDiv.className = 'missing-tool-item mb-3 p-3 bg-light rounded';
                    toolDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>‚ùå ${tool.name}</strong>
                            <span class="badge bg-${tool.category === 'optional' ? 'warning' : 'danger'}">${tool.category}</span>
                        </div>
                        <p class="mb-2 small text-muted">${tool.description}</p>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control font-monospace" value="${tool.install_cmd}" id="cmd-${tool.name}" readonly>
                            <button class="btn btn-outline-primary" type="button" onclick="copyCommand('cmd-${tool.name}')">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                    `;
                    missingList.appendChild(toolDiv);
                });
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö, –Ω–æ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —É—Ç–∏–ª–∏—Ç
            if (toolsData.warnings && toolsData.warnings.length > 0) {
                toolsData.warnings.forEach(tool => {
                    const toolDiv = document.createElement('div');
                    toolDiv.className = 'missing-tool-item mb-3 p-3 bg-warning bg-opacity-10 rounded border border-warning';
                    toolDiv.innerHTML = `
                        <div class="d-flex align-items-center mb-2">
                            <strong>‚ö†Ô∏è ${tool.name}</strong>
                            <span class="ms-2 text-warning">${tool.warning}</span>
                        </div>
                        ${tool.fix_cmd ? `
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control font-monospace" value="${tool.fix_cmd}" id="fix-${tool.name}" readonly>
                            <button class="btn btn-outline-warning" type="button" onclick="copyCommand('fix-${tool.name}')">
                                <i class="bi bi-clipboard"></i> {{ _('–ò—Å–ø—Ä–∞–≤–∏—Ç—å') }}
                            </button>
                        </div>
                        ` : ''}
                    `;
                    missingList.appendChild(toolDiv);
                });
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö —É—Ç–∏–ª–∏—Ç
            if (toolsData.install_all_cmd) {
                document.getElementById('install-all-section').classList.remove('d-none');
                document.getElementById('install-all-cmd').value = toolsData.install_all_cmd;
            } else {
                document.getElementById('install-all-section').classList.add('d-none');
            }
        }
    } catch (error) {
        console.error('Error checking required tools:', error);
        showConnectionError('timeout', error.message);
    }
}

// Copy command to clipboard
function copyCommand(inputId) {
    const input = document.getElementById(inputId);
    if (input) {
        input.select();
        input.setSelectionRange(0, 99999); // For mobile devices
        navigator.clipboard.writeText(input.value).then(() => {
            // Visual feedback
            const button = input.nextElementSibling;
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="bi bi-check-lg"></i> {{ _("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!") }}';
            button.classList.add('btn-success');
            button.classList.remove('btn-outline-primary', 'btn-outline-secondary', 'btn-outline-warning');
            
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('btn-success');
                const classes = inputId.includes('fix-') ? 'btn-outline-warning' : 
                               inputId.includes('install-all') ? 'btn-outline-secondary' : 'btn-outline-primary';
                button.classList.add(classes);
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy:', err);
        });
    }
}

// ========================================
// ERROR HANDLING
// ========================================

let errorCount = 0;
const MAX_ERRORS = 3;
let intervals = []; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö setInterval

function handleError(message, context = '') {
    errorCount++;
    console.warn(`‚ö†Ô∏è Error ${errorCount}/${MAX_ERRORS} [${context}]: ${message}`);
    
    if (errorCount >= MAX_ERRORS) {
        console.error('‚ùå Too many errors! Stopping auto-refresh.');
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
        stopAllIntervals();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        showErrorNotification('{{ _("–ü–æ—Ç–µ—Ä—è–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.") }}');
    }
}

function stopAllIntervals() {
    console.log('üõë Stopping all auto-refresh intervals...');
    intervals.forEach(interval => clearInterval(interval));
    intervals = [];
}

function showErrorNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'alert alert-danger alert-dismissible fade show';
    notification.style.position = 'fixed';
    notification.style.top = '80px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.style.maxWidth = '400px';
    notification.innerHTML = `
        <div class="d-flex align-items-start">
            <div style="font-size: 2rem; margin-right: 15px;">‚ö†Ô∏è</div>
            <div>
                <strong>{{ _("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è") }}</strong><br>
                ${message}
                <div class="mt-2">
                    <button class="btn btn-sm btn-primary" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise"></i> {{ _("–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É") }}
                    </button>
                </div>
            </div>
            <button type="button" class="btn-close ms-2" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.body.appendChild(notification);
}

// ========================================
// INSTALLATION LOGIC
// ========================================

let isInstalling = false;
let isUninstalling = false;
let currentEventSource = null;

async function checkInstallation() {
    console.log('üîß Checking monitoring installation status...');
    console.log('üîó URL:', `/api/monitoring/${serverId}/check-installed`);
    try {
        const response = await fetch(`/api/monitoring/${serverId}/check-installed`);
        console.log('üì° Response status:', response.status);
        
        if (!response.ok) {
            console.error('‚ùå Response not OK:', response.status, response.statusText);
            return false;
        }
        
        const data = await response.json();
        console.log('üìä Installation check result:', data);
        console.log('‚úÖ Installed:', data.installed);
        
        if (!data.installed && data.error) {
            console.error('‚ùå Check error:', data.error);
        }
        
        return data.installed || false;
    } catch (error) {
        console.error('üí• Error checking installation:', error);
        return false;
    }
}

function showInstallationPanel() {
    console.log('üì¶ Showing installation panel');
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const loadingIndicator = document.getElementById('initial-loading');
    if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
    }
    
    document.getElementById('installation-panel').style.display = 'block';
    document.getElementById('stats-container').style.display = 'none';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
    document.getElementById('install-btn').addEventListener('click', function() {
        startInstallation();
    });
}

function showMonitoring() {
    console.log('üìä Showing monitoring stats');
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const loadingIndicator = document.getElementById('initial-loading');
    if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫
    const monitoringControls = document.getElementById('monitoring-controls');
    if (monitoringControls) {
        monitoringControls.style.display = 'block';
    }
    
    document.getElementById('installation-panel').style.display = 'none';
    document.getElementById('stats-container').style.display = 'block';
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
    initMonitoring();
    
    // setupSettingsPanel() —É–∂–µ –≤—ã–∑–≤–∞–Ω –≤ DOMContentLoaded
}

function setupSettingsPanel() {
    console.log('‚öôÔ∏è Setting up settings panel...');
    
    // –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    const showSettingsBtn = document.getElementById('show-settings-btn');
    if (showSettingsBtn) {
        const newShowBtn = showSettingsBtn.cloneNode(true);
        showSettingsBtn.parentNode.replaceChild(newShowBtn, showSettingsBtn);
        
        newShowBtn.addEventListener('click', function() {
            console.log('üîß Opening settings panel');
            document.getElementById('settings-panel').classList.add('active');
        });
    }
    
    // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    const closeSettingsBtn = document.getElementById('close-settings-btn');
    if (closeSettingsBtn) {
        const newCloseBtn = closeSettingsBtn.cloneNode(true);
        closeSettingsBtn.parentNode.replaceChild(newCloseBtn, closeSettingsBtn);
        
        newCloseBtn.addEventListener('click', function() {
            console.log('‚ùå Closing settings panel');
            document.getElementById('settings-panel').classList.remove('active');
        });
    }
    
    // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    const uninstallBtn = document.getElementById('uninstall-btn');
    if (uninstallBtn) {
        const newUninstallBtn = uninstallBtn.cloneNode(true);
        uninstallBtn.parentNode.replaceChild(newUninstallBtn, uninstallBtn);
        
        newUninstallBtn.addEventListener('click', function() {
            console.log('üóëÔ∏è Uninstall button (sidebar) clicked');
            showUninstallModal();
        });
    }
    
    // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ (–Ω–æ–≤–∞—è)
    const uninstallBtnMain = document.getElementById('uninstall-btn-main');
    if (uninstallBtnMain) {
        const newUninstallBtnMain = uninstallBtnMain.cloneNode(true);
        uninstallBtnMain.parentNode.replaceChild(newUninstallBtnMain, uninstallBtnMain);
        
        newUninstallBtnMain.addEventListener('click', function() {
            console.log('üóëÔ∏è Uninstall button (main) clicked');
            showUninstallModal();
        });
    }
    
    console.log('‚úÖ Settings panel configured');
}

async function startInstallation() {
    if (isInstalling) {
        console.warn('‚ö†Ô∏è Installation already in progress');
        return;
    }
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    const installBtn = document.getElementById('install-btn');
    const originalText = installBtn.innerHTML;
    installBtn.disabled = true;
    installBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>{{ _("–ü—Ä–æ–≤–µ—Ä–∫–∞...") }}';
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ —É–∂–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
    console.log('üîç Checking if monitoring is already installed...');
    const alreadyInstalled = await checkInstallation();
    if (alreadyInstalled) {
        console.warn('‚ö†Ô∏è Monitoring is already installed on this server!');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const notification = document.createElement('div');
        notification.className = 'alert alert-info alert-dismissible fade show';
        notification.style.position = 'fixed';
        notification.style.top = '80px';
        notification.style.right = '20px';
        notification.style.zIndex = '9999';
        notification.style.maxWidth = '400px';
        notification.innerHTML = `
            <div class="d-flex align-items-start">
                <div style="font-size: 2rem; margin-right: 15px;">‚úÖ</div>
                <div>
                    <strong>{{ _("–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω") }}</strong><br>
                    <span class="small">{{ _("–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞ –Ω–∞ —ç—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ. –°–µ–π—á–∞—Å –∑–∞–≥—Ä—É–∑–∏–º –¥–∞–Ω–Ω—ã–µ...") }}</span>
                </div>
                <button type="button" class="btn-close ms-2" data-bs-dismiss="alert"></button>
            </div>
        `;
        document.body.appendChild(notification);
        
        // –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
        setTimeout(() => {
            location.reload();
        }, 2000);
        return;
    }
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É
    installBtn.innerHTML = originalText;
    
    isInstalling = true;
    console.log('üöÄ Starting installation...');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    installBtn.disabled = true;
    document.getElementById('install-progress').style.display = 'block';
    
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const logsContainer = document.getElementById('install-logs');
    const cancelBtn = document.getElementById('cancel-install-btn');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–º–µ–Ω—ã
    cancelBtn.style.display = 'block';
    cancelBtn.onclick = function() {
        cancelInstallation();
    };
    
    try {
        // –°–æ–∑–¥–∞–µ–º EventSource –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —á–µ—Ä–µ–∑ SSE
        currentEventSource = new EventSource(`/api/monitoring/${serverId}/install`);
        
        currentEventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            console.log('üì• Installation progress:', data);
            
            // –û—Ç–º–µ–Ω–∞
            if (data.cancelled) {
                addLog(logsContainer, data.message, 'warning');
                currentEventSource.close();
                resetInstallation();
                return;
            }
            
            if (data.error) {
                // –û—à–∏–±–∫–∞
                addLog(logsContainer, `‚ùå –û—à–∏–±–∫–∞: ${data.error}`, 'error');
                currentEventSource.close();
                resetInstallation();
                return;
            }
            
            if (data.complete) {
                // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
                currentEventSource.close();
                addLog(logsContainer, 'üéâ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
                addLog(logsContainer, 'üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã...', 'info');
                cancelBtn.style.display = 'none';
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è —á–∏—Å—Ç–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞
                setTimeout(function() {
                    window.location.reload();
                }, 3000);
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            if (data.step && data.total) {
                const percent = Math.round((data.step / data.total) * 100);
                progressBar.style.width = `${percent}%`;
                progressText.textContent = `${percent}%`;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ª–æ–≥
            if (data.message) {
                addLog(logsContainer, data.message, data.status);
            }
        };
        
        currentEventSource.onerror = function(error) {
            console.error('EventSource error:', error);
            currentEventSource.close();
            addLog(logsContainer, '‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
            resetInstallation();
        };
        
    } catch (error) {
        console.error('Installation error:', error);
        addLog(logsContainer, `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        resetInstallation();
    }
}

async function cancelInstallation() {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/monitoring/${serverId}/cancel-install`, {
            method: 'POST'
        });
        
        if (response.ok) {
            console.log('Cancellation requested');
        }
    } catch (error) {
        console.error('Error cancelling installation:', error);
    }
}

function resetInstallation() {
    isInstalling = false;
    document.getElementById('install-btn').disabled = false;
    document.getElementById('cancel-install-btn').style.display = 'none';
}

function showUninstallModal() {
    console.log('üóëÔ∏è Opening uninstall modal');
    
    const modalEl = document.getElementById('uninstallModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    const confirmBtn = document.getElementById('confirm-uninstall-btn');
    const cancelBtn = document.getElementById('cancel-uninstall-btn');
    
    confirmBtn.style.display = 'block';
    cancelBtn.style.display = 'block';
    document.getElementById('uninstall-progress').style.display = 'none';
    document.getElementById('uninstall-logs').innerHTML = '';
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    newConfirmBtn.onclick = function() {
        console.log('‚úÖ User confirmed uninstallation');
        startUninstallation();
    };
    
    console.log('‚úÖ Uninstall modal configured');
}

async function startUninstallation() {
    if (isUninstalling) {
        console.warn('‚ö†Ô∏è Uninstallation already in progress');
        return;
    }
    
    console.log('üóëÔ∏è Starting uninstallation process...');
    isUninstalling = true;
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    document.getElementById('confirm-uninstall-btn').style.display = 'none';
    document.getElementById('cancel-uninstall-btn').style.display = 'none';
    document.getElementById('uninstall-progress').style.display = 'block';
    
    const progressBar = document.getElementById('uninstall-progress-bar');
    const progressText = document.getElementById('uninstall-progress-text');
    const logsContainer = document.getElementById('uninstall-logs');
    
    console.log('üì° Connecting to uninstall endpoint...');
    
    try {
        const eventSource = new EventSource(`/api/monitoring/${serverId}/uninstall`);
        
        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            
            if (data.error) {
                addLog(logsContainer, `‚ùå –û—à–∏–±–∫–∞: ${data.error}`, 'error');
                eventSource.close();
                isUninstalling = false;
                return;
            }
            
            if (data.complete) {
                eventSource.close();
                addLog(logsContainer, data.message || 'üéâ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É–¥–∞–ª–µ–Ω!', 'success');
                addLog(logsContainer, 'üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã...', 'info');
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è —á–∏—Å—Ç–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞
                setTimeout(function() {
                    window.location.reload();
                }, 3000);
                return;
            }
            
            if (data.step && data.total) {
                const percent = Math.round((data.step / data.total) * 100);
                progressBar.style.width = `${percent}%`;
                progressText.textContent = `${percent}%`;
            }
            
            if (data.message) {
                addLog(logsContainer, data.message, data.status);
            }
        };
        
        eventSource.onerror = function(error) {
            console.error('EventSource error:', error);
            eventSource.close();
            addLog(logsContainer, '‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
            isUninstalling = false;
        };
        
    } catch (error) {
        console.error('Uninstallation error:', error);
        addLog(logsContainer, `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        isUninstalling = false;
    }
}

function addLog(container, message, status) {
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry log-${status}`;
    logEntry.textContent = message;
    container.appendChild(logEntry);
    container.scrollTop = container.scrollHeight;
}

function initMonitoring() {
    console.log('üéØ Initializing monitoring displays...');
    
    createCharts();
    
    // Initial updates
    console.log('‚è±Ô∏è Starting initial data load...');
    checkRequiredTools(); // Check tools first
    updateNetworkStats();
    updateFirewallStatus();
    updateServicesStatus();
    updateSecurityEvents();
    updateCharts();
    
    // Set up intervals (—É–≤–µ–ª–∏—á–µ–Ω—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏) –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ö
    console.log('‚è∞ Setting up auto-refresh intervals (safe mode: 30s) with error handling');
    intervals.push(setInterval(updateNetworkStats, 30000));      // 30 seconds (–±—ã–ª–æ 5)
    intervals.push(setInterval(updateFirewallStatus, 30000));    // 30 seconds (–±—ã–ª–æ 10)
    intervals.push(setInterval(updateServicesStatus, 30000));    // 30 seconds (–±—ã–ª–æ 10)
    intervals.push(setInterval(updateSecurityEvents, 60000));    // 60 seconds (–±—ã–ª–æ 30)
    intervals.push(setInterval(updateCharts, 120000));           // 120 seconds (–±—ã–ª–æ 60)
    console.log(`‚úÖ Created ${intervals.length} monitoring intervals with auto-stop on errors`)
    
    console.log('‚úÖ Monitoring fully initialized');
}

// Initialize
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ Page loaded, checking installation...');
    
    // –í–ê–ñ–ù–û: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –í–°–ï–ì–î–ê (–∫–Ω–æ–ø–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ DOM)
    setupSettingsPanel();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
    const isInstalled = await checkInstallation();
    
    if (isInstalled) {
        // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        showMonitoring();
    } else {
        // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏
        showInstallationPanel();
    }
});
</script>
{% endblock %}

