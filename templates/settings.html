{% extends "layout.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</h2>

    <!-- –ë–ª–æ–∫ –¥–ª—è –≤—ã–≤–æ–¥–∞ flash-—Å–æ–æ–±—â–µ–Ω–∏–π -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–æ–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-key"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–æ–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è</h5>
        </div>
        <div class="card-body">
            
            <!-- –°–º–µ–Ω–∞ –∫–ª—é—á–∞ -->
            <div class="row mb-4">
                <div class="col-lg-6">
                    <h6 class="text-primary"><i class="bi bi-arrow-repeat"></i> –°–º–µ–Ω–∞ –≥–ª–∞–≤–Ω–æ–≥–æ –∫–ª—é—á–∞</h6>
                    <p class="small text-muted">–ü—Ä–∏ —Å–º–µ–Ω–µ –∫–ª—é—á–∞ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–∞–Ω–Ω—ã—Ö. –°—Ç–∞—Ä—ã–π —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è.</p>
                    
                    <form action="{{ url_for('change_main_key') }}" method="post" onsubmit="return confirmKeyChange()">
                        <div class="mb-3">
                            <label for="newKey" class="form-label">–ù–æ–≤—ã–π –∫–ª—é—á</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="new_key" id="newKey" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –∫–ª—é—á Fernet">
                                <button type="button" class="btn btn-outline-secondary" onclick="generateRandomKey()">
                                    <i class="bi bi-dice-3"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="confirmKey" class="form-label">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–ª—é—á–∞</label>
                            <input type="text" class="form-control" name="confirm_key" id="confirmKey" required placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –∫–ª—é—á">
                        </div>
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-arrow-repeat"></i> –°–º–µ–Ω–∏—Ç—å –∫–ª—é—á
                        </button>
                    </form>
                </div>
                
                <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∫–ª—é—á-–¥–∞–Ω–Ω—ã–µ -->
                <div class="col-lg-6">
                    <h6 class="text-primary"><i class="bi bi-search"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∫–ª—é—á-–¥–∞–Ω–Ω—ã–µ</h6>
                    <p class="small text-muted">–ë—ã—Å—Ç—Ä–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø–æ–¥—Ö–æ–¥–∏—Ç –ª–∏ –∫–ª—é—á –∫ —Ñ–∞–π–ª—É –¥–∞–Ω–Ω—ã—Ö, –±–µ–∑ –∏–º–ø–æ—Ä—Ç–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.</p>
                    
                    <form action="{{ url_for('verify_key_data') }}" method="post" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="verifyFile" class="form-label">–§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö (.enc)</label>
                            <input type="file" class="form-control" name="verify_file" id="verifyFile" accept=".enc" required>
                        </div>
                        <div class="mb-3">
                            <label for="verifyKey" class="form-label">–ö–ª—é—á –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏</label>
                            <textarea class="form-control" name="verify_key" id="verifyKey" rows="3" required placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏"></textarea>
                        </div>
                        <button type="submit" class="btn btn-info">
                            <i class="bi bi-search"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å —Ñ–∞–π–ª–∞ –¥–∞–Ω–Ω—ã—Ö -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-database"></i> –°—Ç–∞—Ç—É—Å —Ñ–∞–π–ª–∞ –¥–∞–Ω–Ω—ã—Ö</h5>
        </div>
        <div class="card-body">
            {% if active_data_file %}
                <div class="alert alert-success" role="alert">
                    <i class="bi bi-check-circle-fill"></i> 
                    <strong>–ê–∫—Ç–∏–≤–Ω—ã–π —Ñ–∞–π–ª:</strong> <code>{{ active_data_file }}</code>
                </div>
                <p class="text-muted">–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ —Å–µ—Ä–≤–µ—Ä–∞—Ö –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ —ç—Ç–æ–≥–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞.</p>
                
                <!-- –ö–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <button class="btn btn-primary w-100" onclick="showExportInfo('data')">
                            <i class="bi bi-download"></i> –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
                        </button>
                    </div>
                    <div class="col-md-4 mb-2">
                        <button class="btn btn-warning w-100" onclick="showExportInfo('key')">
                            <i class="bi bi-key"></i> –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á
                        </button>
                    </div>
                    <div class="col-md-4 mb-2">
                        <button class="btn btn-success w-100" onclick="showExportInfo('package')">
                            <i class="bi bi-archive"></i> –ü–æ–ª–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç
                        </button>
                        <small class="text-muted d-block mt-1">
                            <i class="bi bi-key"></i> –í–∫–ª—é—á–∞–µ—Ç PIN-–∫–æ–¥
                        </small>
                    </div>
                </div>
                
                <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —ç–∫—Å–ø–æ—Ä—Ç–µ -->
                <div id="exportNotification" class="alert alert-info mt-3" style="display: none;">
                    <i class="bi bi-info-circle"></i> 
                    <strong>–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–ø—É—â–µ–Ω!</strong> 
                    <span id="exportMessage"></span>
                    <br><small>üìÅ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞–ø–∫—É —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º VPN Server Manager.</small>
                </div>
                
                <div class="mt-3">
                <form action="{{ url_for('detach_data') }}" method="post" class="d-inline" onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª –¥–∞–Ω–Ω—ã—Ö? –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ –±—É–¥–µ—Ç –ø—É—Å—Ç.');">
                    <button type="submit" class="btn btn-outline-danger">
                        <i class="bi bi-unlock"></i> –û—Ç–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª
                    </button>
                </form>
                </div>
            {% else %}
                <div class="alert alert-warning" role="alert">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>–§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω.</strong>
                </div>
                <p class="text-muted">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∫–∞–∫–∏–º-–ª–∏–±–æ —Ñ–∞–π–ª–æ–º –¥–∞–Ω–Ω—ã—Ö. –í—ã –º–æ–∂–µ—Ç–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª, —á—Ç–æ–±—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–≤–æ–∏ –∑–∞–ø–∏—Å–∏.</p>
            {% endif %}
        </div>
    </div>

    <!-- –ò–º–ø–æ—Ä—Ç —Ñ–∞–π–ª–∞ –¥–∞–Ω–Ω—ã—Ö -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-upload"></i> –ò–º–ø–æ—Ä—Ç —Ñ–∞–π–ª–∞ –¥–∞–Ω–Ω—ã—Ö</h5>
        </div>
        <div class="card-body">
            <p class="text-muted">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–∞–Ω–Ω—ã—Ö (<code>.enc</code>), —á—Ç–æ–±—ã –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –µ–≥–æ –∏ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–∏–º. –¢–µ–∫—É—â–∏–π –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å) –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω.</p>
            <form action="{{ url_for('import_data') }}" method="post" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="dataFile" class="form-label">–í—ã–±–æ—Ä —Ñ–∞–π–ª–∞ –¥–∞–Ω–Ω—ã—Ö</label>
                    <input type="file" class="form-control" name="data_file" id="dataFile" accept=".enc" required>
                    <div class="form-text">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º <code>.enc</code>, —Ä–∞–Ω–µ–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–∑ —ç—Ç–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.</div>
                </div>
                <div class="d-grid">
                    <button class="btn btn-success" type="submit">
                        <i class="bi bi-upload"></i> –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ò–º–ø–æ—Ä—Ç –∏–∑ –¥—Ä—É–≥–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ -->
    <div class="card">
        <div class="card-header d-flex align-items-center">
            <i class="bi bi-plus-circle me-2"></i>
            <h5 class="mb-0">–ò–º–ø–æ—Ä—Ç —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏–∑ –¥—Ä—É–≥–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-light border" role="alert">
                <i class="bi bi-info-circle"></i> <strong>–ß—Ç–æ –Ω—É–∂–Ω–æ:</strong> —Ñ–∞–π–ª <code>.env</code> –∏ <code>servers.json.enc</code> –∏–∑ –¥—Ä—É–≥–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
            </div>

            <form action="{{ url_for('import_external_data') }}" method="post" enctype="multipart/form-data">
                <div class="row">
                    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: servers.json.enc —Ñ–∞–π–ª -->
                    <div class="col-md-6">
                        <h6 class="text-primary">servers.json.enc —Ñ–∞–π–ª</h6>
                <div class="mb-3">
                            <label for="envFile" class="form-label">–§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö (.enc)</label>
                            <input type="file" class="form-control" name="external_file" id="envFile" accept=".enc" required>
                    <div class="form-text">–í—ã–±–µ—Ä–∞—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–∞–Ω–Ω—ã—Ö –∏–∑ –¥—Ä—É–≥–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏</div>
                </div>
                    </div>

                    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: .env —Ñ–∞–π–ª —Å SECRET_KEY -->
                    <div class="col-md-6">
                        <h6 class="text-primary">.env —Ñ–∞–π–ª —Å SECRET_KEY</h6>
                <div class="mb-3">
                    <label for="externalKey" class="form-label">–í–Ω–µ—à–Ω–∏–π –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è</label>
                            <textarea class="form-control" name="external_key" id="externalKey" rows="4" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞ .env –¥—Ä—É–≥–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: k-IgKHDDBZxqwr5oaBNkQzCjD71i2N3VctHIfOA663w=)" required></textarea>
                    <div class="form-text">
                        <strong>–ì–¥–µ –Ω–∞–π—Ç–∏ –∫–ª—é—á:</strong><br>
                        ‚Ä¢ –í —Ñ–∞–π–ª–µ <code>.env</code> –≤ –ø–∞–ø–∫–µ —Å –¥—Ä—É–≥–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π<br>
                        ‚Ä¢ –ò—â–∏—Ç–µ —Å—Ç—Ä–æ–∫—É <code>SECRET_KEY=</code><br>
                        ‚Ä¢ –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–Ω–∞–∫–∞ —Ä–∞–≤–µ–Ω—Å—Ç–≤–∞
                    </div>
                </div>
                    </div>
                </div>

                <div class="alert alert-warning" role="alert">
                    <strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è —Å–µ—Ä–≤–µ—Ä–∞ (–ø–æ IP –∏–ª–∏ –∏–º–µ–Ω–∏) –±—É–¥—É—Ç –ø—Ä–æ–ø—É—â–µ–Ω—ã. –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ–ª—É—á–∞—Ç –Ω–æ–≤—ã–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ ID –∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫ –≤–∞—à–µ–º—É —Å–ø–∏—Å–∫—É.
                </div>

                <div class="d-grid">
                    <button class="btn btn-warning" type="submit">
                        <i class="bi bi-arrow-down-circle"></i> –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å —Å–µ—Ä–≤–µ—Ä–∞
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function showExportMessage(fileType) {
    const notification = document.getElementById('exportNotification');
    const message = document.getElementById('exportMessage');
    
    message.textContent = `–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è ${fileType}`;
    notification.style.display = 'block';
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        notification.style.display = 'none';
    }, 5000);
}

function confirmKeyChange() {
    const newKey = document.getElementById('newKey').value;
    const confirmKey = document.getElementById('confirmKey').value;
    
    if (newKey !== confirmKey) {
        alert('–ö–ª—é—á–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!');
        return false;
    }
    
    return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–º–µ–Ω–∏—Ç—å –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è? –≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—ã–π —Ñ–∞–π–ª –¥–∞–Ω–Ω—ã—Ö –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Å—Ç–∞—Ä–æ–≥–æ.');
}

async function generateRandomKey() {
    try {
        const response = await fetch('/settings/generate-key', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('newKey').value = data.key;
            document.getElementById('confirmKey').value = data.key;
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–∞: ' + data.error);
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–∞: ' + error.message);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —ç–∫—Å–ø–æ—Ä—Ç–µ
function showExportInfo(exportType) {
    const modal = document.getElementById('exportInfoModal');
    const exportTypeElement = document.getElementById('exportTypeText');
    const exportLocationElement = document.getElementById('exportLocationText');
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏ —Ñ–∞–π–ª—ã
    let typeText, locationText;
    switch(exportType) {
        case 'data':
            typeText = '–§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ (.enc)';
            locationText = 'servers_export_[–¥–∞—Ç–∞_–≤—Ä–µ–º—è].enc';
            break;
        case 'key':
            typeText = '–ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (.env)';
            locationText = 'SECRET_KEY_[–¥–∞—Ç–∞_–≤—Ä–µ–º—è].env';
            break;
        case 'package':
            typeText = '–ü–æ–ª–Ω—ã–π –∞—Ä—Ö–∏–≤ (.zip)';
            locationText = 'vpn_servers_backup_[–¥–∞—Ç–∞_–≤—Ä–µ–º—è].zip';
            break;
    }
    
    exportTypeElement.textContent = typeText;
    exportLocationElement.textContent = locationText;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —ç–∫—Å–ø–æ—Ä—Ç–∞
    const packageInfo = document.getElementById('packageInfo');
    if (exportType === 'package') {
        packageInfo.style.display = 'block';
    } else {
        packageInfo.style.display = 'none';
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    modal.style.display = 'block';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞
function confirmExport(exportType) {
    const modal = document.getElementById('exportInfoModal');
    modal.style.display = 'none';
    
    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π URL —ç–∫—Å–ø–æ—Ä—Ç–∞
    switch(exportType) {
        case 'data':
            window.location.href = '/data/export';
            break;
        case 'key':
            window.location.href = '/data/export_key';
            break;
        case 'package':
            window.location.href = '/data/export_package';
            break;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function closeExportModal() {
    document.getElementById('exportInfoModal').style.display = 'none';
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
window.onclick = function(event) {
    const modal = document.getElementById('exportInfoModal');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —ç–∫—Å–ø–æ—Ä—Ç–µ -->
<div id="exportInfoModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color: #2c3e50; margin: 15% auto; padding: 20px; border: none; border-radius: 10px; width: 80%; max-width: 500px; color: white;">
        <div class="modal-header" style="border-bottom: 1px solid #34495e; padding-bottom: 10px; margin-bottom: 20px;">
            <h4 style="margin: 0; color: #3498db;">
                <i class="bi bi-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —ç–∫—Å–ø–æ—Ä—Ç–µ
            </h4>
            <span class="close" onclick="closeExportModal()" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1;">&times;</span>
        </div>
        <div class="modal-body">
            <div class="alert alert-info" style="background-color: #1f2937; border: 1px solid #3498db; color: #3498db; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                <strong>–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è:</strong> <span id="exportTypeText"></span>
                <div id="packageInfo" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #3498db;">
                    <i class="bi bi-key"></i> <strong>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞—Ä—Ö–∏–≤–∞:</strong>
                    <ul style="margin: 5px 0 0 20px; color: #bdc3c7;">
                        <li>–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–æ–≤</li>
                        <li>–ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (.env)</li>
                        <li>PIN-–∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞ (PIN.txt)</li>
                        <li>–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (uploads/)</li>
                        <li>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏–º–ø–æ—Ä—Ç—É (README.txt)</li>
                    </ul>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h6 style="color: #2ecc71; margin-bottom: 10px;">
                    <i class="bi bi-folder"></i> –ú–µ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:
                </h6>
                <div style="background-color: #1f2937; padding: 10px; border-radius: 5px; font-family: monospace; word-break: break-all;">
                    <strong>üìÅ ~/Downloads/</strong><br>
                    <span id="exportLocationText" style="color: #f39c12;"></span>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h6 style="color: #e74c3c; margin-bottom: 10px;">
                    <i class="bi bi-exclamation-triangle"></i> –í–∞–∂–Ω–æ:
                </h6>
                <ul style="margin: 0; padding-left: 20px; color: #bdc3c7;">
                    <li>–§–∞–π–ª –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ –±—Ä–∞—É–∑–µ—Ä–µ</li>
                    <li>–¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞–ø–∫—É <strong>Downloads</strong></li>
                    <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É Downloads –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</li>
                </ul>
            </div>
        </div>
        <div class="modal-footer" style="border-top: 1px solid #34495e; padding-top: 15px; text-align: right;">
            <button type="button" class="btn btn-secondary" onclick="closeExportModal()" style="margin-right: 10px;">
                –û—Ç–º–µ–Ω–∞
            </button>
            <button type="button" class="btn btn-success" onclick="confirmExport(currentExportType)" id="confirmExportBtn">
                <i class="bi bi-download"></i> –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç
            </button>
        </div>
    </div>
</div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞
let currentExportType = '';

// –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é confirmExport –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∏–ø–∞
function showExportInfo(exportType) {
    currentExportType = exportType;
    const modal = document.getElementById('exportInfoModal');
    const exportTypeElement = document.getElementById('exportTypeText');
    const exportLocationElement = document.getElementById('exportLocationText');
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏ —Ñ–∞–π–ª—ã
    let typeText, locationText;
    switch(exportType) {
        case 'data':
            typeText = '–§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ (.enc)';
            locationText = 'servers_export_[–¥–∞—Ç–∞_–≤—Ä–µ–º—è].enc';
            break;
        case 'key':
            typeText = '–ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (.env)';
            locationText = 'SECRET_KEY_[–¥–∞—Ç–∞_–≤—Ä–µ–º—è].env';
            break;
        case 'package':
            typeText = '–ü–æ–ª–Ω—ã–π –∞—Ä—Ö–∏–≤ (.zip)';
            locationText = 'vpn_servers_backup_[–¥–∞—Ç–∞_–≤—Ä–µ–º—è].zip';
            break;
    }
    
    exportTypeElement.textContent = typeText;
    exportLocationElement.textContent = locationText;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    modal.style.display = 'block';
}
</script>

{% endblock %} 