{% extends "layout.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card text-center shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="bi bi-lock-fill"></i> {{ _('–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω') }}
                    </h3>
                </div>
                <div class="card-body py-5">
                    <div class="mb-4">
                        <i class="bi bi-shield-lock display-1 text-muted"></i>
                    </div>
                    <h4 class="card-title mb-3">üîê {{ _('–¢—Ä–µ–±—É–µ—Ç—Å—è PIN-–∫–æ–¥') }}</h4>
                    <p class="card-text text-muted mb-4">
                        {{ _('–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ PIN-–∫–æ–¥.') }}
                    </p>
                    
                    <div id="firstTimeHint" class="alert alert-info" role="alert" style="display: none;">
                        <i class="bi bi-lightbulb"></i>
                        <strong>{{ _('–°–æ–≤–µ—Ç:') }}</strong> {{ _('–ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–ø–µ—Ä–≤—ã–µ, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è PIN-–∫–æ–¥–∞.') }}
                    </div>
                    
                    <!-- –°—á–µ—Ç—á–∏–∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ -->
                    <div id="blockCounter" class="alert alert-danger" style="display: none;">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="bi bi-lock-fill me-2"></i>
                            <span id="blockTimer">üîí {{ _('–í—Ö–æ–¥ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞') }} <strong id="countdown">30</strong> {{ _('—Å–µ–∫—É–Ω–¥') }}</span>
                        </div>
                        <div class="progress mt-2">
                            <div id="blockProgressBar" class="progress-bar bg-danger" role="progressbar" style="width: 100%"></div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-3 d-sm-flex justify-content-sm-center mt-4">
                        <button type="button" class="btn btn-primary btn-lg px-4" onclick="showPinLoginModal()" id="pinLoginButton">
                            <i class="bi bi-key"></i> {{ _('–í–≤–µ—Å—Ç–∏ PIN') }}
                        </button>
                        <button id="firstSetupButton" type="button" class="btn btn-secondary btn-lg px-4" onclick="showFirstTimeSetup()" style="display: none;">
                            <i class="bi bi-plus-circle"></i> {{ _('–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫') }}
                        </button>
                    </div>
                </div>
                <div class="card-footer text-muted">
                    <small>
                        <i class="bi bi-shield-check"></i> 
                        {{ _('–í—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞—â–∏—â–µ–Ω—ã —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º. PIN-–∫–æ–¥ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∑–∞—â–∏—Ç—É.') }}
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ PIN -->
<div class="modal fade" id="pinLoginModal" tabindex="-1" aria-labelledby="pinLoginModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pinLoginModalLabel">
                    <i class="bi bi-key"></i> {{ _('–í—Ö–æ–¥ –ø–æ PIN-–∫–æ–¥—É') }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ -->
                <ul class="nav nav-tabs" id="pinLoginTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="login-tab" data-bs-toggle="tab" 
                                data-bs-target="#login-pane" type="button" role="tab" 
                                aria-controls="login-pane" aria-selected="true">{{ _('–í—Ö–æ–¥') }}</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="change-pin-tab" data-bs-toggle="tab" 
                                data-bs-target="#change-pin-pane" type="button" role="tab" 
                                aria-controls="change-pin-pane" aria-selected="false">{{ _('–°–º–µ–Ω–∏—Ç—å PIN') }}</button>
                    </li>
                </ul>
                
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫ -->
                <div class="tab-content" id="pinLoginTabContent">
                    <!-- –í–∫–ª–∞–¥–∫–∞ –≤—Ö–æ–¥–∞ -->
                    <div class="tab-pane fade show active" id="login-pane" role="tabpanel" 
                         aria-labelledby="login-tab">
                        <p class="text-muted mb-3 mt-3">{{ _('–í–≤–µ–¥–∏—Ç–µ PIN-–∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É') }}</p>
                        <div class="mb-3">
                            <label for="pinInput" class="form-label">{{ _('PIN-–∫–æ–¥') }}</label>
                            <input type="password" class="form-control" id="pinInput" 
                                   placeholder="{{ _('–í–≤–µ–¥–∏—Ç–µ PIN') }}" maxlength="4" autocomplete="off">
                        </div>
                        <div id="pinLoginMessage" class="alert" style="display: none;"></div>
                    </div>
                    
                    <!-- –í–∫–ª–∞–¥–∫–∞ —Å–º–µ–Ω—ã PIN -->
                    <div class="tab-pane fade" id="change-pin-pane" role="tabpanel" 
                         aria-labelledby="change-pin-tab">
                        <p class="text-muted mb-3 mt-3">{{ _('–°–º–µ–Ω–∏—Ç–µ PIN-–∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞') }}</p>
                        <form id="changePinForm">
                            <div class="mb-3">
                                <label for="oldPin" class="form-label">{{ _('–°—Ç–∞—Ä—ã–π PIN') }}</label>
                                <input type="password" class="form-control" id="oldPin" name="old_pin" 
                                       placeholder="{{ _('–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞—Ä—ã–π PIN') }}" maxlength="4" autocomplete="off" required>
                            </div>
                            <div class="mb-3">
                                <label for="newPin1" class="form-label">{{ _('–ù–æ–≤—ã–π PIN') }}</label>
                                <input type="password" class="form-control" id="newPin1" name="new_pin1" 
                                       placeholder="{{ _('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π PIN') }}" maxlength="4" autocomplete="off" required>
                            </div>
                            <div class="mb-3">
                                <label for="newPin2" class="form-label">{{ _('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π PIN') }}</label>
                                <input type="password" class="form-control" id="newPin2" name="new_pin2" 
                                       placeholder="{{ _('–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π PIN') }}" maxlength="4" autocomplete="off" required>
                            </div>
                            <div id="changePinMessage" class="alert" style="display: none;"></div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('–û—Ç–º–µ–Ω–∞') }}</button>
                <button type="button" class="btn btn-primary" id="modalSubmitBtn" 
                        onclick="submitPinLogin()">{{ _('–í–æ–π—Ç–∏') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ -->
<div class="modal fade" id="firstTimeSetupModal" tabindex="-1" aria-labelledby="firstTimeSetupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="firstTimeSetupModalLabel">
                    <i class="bi bi-rocket"></i> {{ _('–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫') }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" role="alert">
                    <i class="bi bi-info-circle"></i>
                    <strong>{{ _('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:') }}</strong> {{ _('–í—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π PIN-–∫–æ–¥ –∏–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ.') }}
                </div>
                <p>{{ _('–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:') }}</p>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary" onclick="setupNewPin()">
                        <i class="bi bi-plus-circle"></i> {{ _('–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π PIN-–∫–æ–¥') }}
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="showArchiveUpload()">
                        <i class="bi bi-upload"></i> {{ _('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ –∞—Ä—Ö–∏–≤–∞') }}
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('–û—Ç–º–µ–Ω–∞') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ö–∏–≤–∞ -->
<div class="modal fade" id="archiveUploadModal" tabindex="-1" aria-labelledby="archiveUploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="archiveUploadModalLabel">
                    <i class="bi bi-archive"></i> {{ _('–ò–º–ø–æ—Ä—Ç –∏–∑ –∞—Ä—Ö–∏–≤–∞') }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" role="alert">
                    <i class="bi bi-info-circle"></i>
                    <strong>{{ _('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:') }}</strong> {{ _('–ó–∞–≥—Ä—É–∑–∏—Ç–µ ZIP –∞—Ä—Ö–∏–≤, —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–µ–π "–ü–æ–ª–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç".') }}
                </div>
                <form id="archiveUploadForm">
                    <div class="mb-3">
                        <label for="archiveFile" class="form-label">{{ _('–í—ã–±–µ—Ä–∏—Ç–µ ZIP –∞—Ä—Ö–∏–≤') }}</label>
                        <div class="input-group">
                            <input type="file" class="form-control" id="archiveFile" name="archive_file" 
                                   accept=".zip" required style="display: none;">
                            <input type="text" class="form-control" id="archiveFileDisplay" 
                                   placeholder="{{ _('–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞') }}" readonly>
                            <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('archiveFile').click()">
                                {{ _('–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª') }}
                            </button>
                        </div>
                        <div class="form-text">{{ _('–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω') }}</div>
                    </div>
                    <div id="archiveMessage" class="alert" style="display: none;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('–û—Ç–º–µ–Ω–∞') }}</button>
                <button type="button" class="btn btn-info" onclick="checkArchiveForPin()">{{ _('–ü—Ä–æ–≤–µ—Ä–∏—Ç—å PIN') }}</button>
                <button type="button" class="btn btn-success" onclick="importArchiveData()">{{ _('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ PIN -->
<div class="modal fade" id="createPinModal" tabindex="-1" aria-labelledby="createPinModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createPinModalLabel">
                    <i class="bi bi-plus-circle"></i> {{ _('–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ PIN-–∫–æ–¥–∞') }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" role="alert">
                    <i class="bi bi-info-circle"></i>
                    <strong>{{ _('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:') }}</strong> {{ _('–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π PIN-–∫–æ–¥ –¥–ª—è –∑–∞—â–∏—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.') }}
                </div>
                <form id="createPinForm">
                    <div class="mb-3">
                        <label for="newPinInput" class="form-label">{{ _('–ù–æ–≤—ã–π PIN-–∫–æ–¥') }}</label>
                        <input type="password" class="form-control" id="newPinInput" name="new_pin" 
                               placeholder="{{ _('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π PIN (–º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞)') }}" maxlength="4" autocomplete="off" required>
                        <div class="form-text">{{ _('PIN –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞') }}</div>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPinInput" class="form-label">{{ _('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ PIN-–∫–æ–¥') }}</label>
                        <input type="password" class="form-control" id="confirmPinInput" name="confirm_pin" 
                               placeholder="{{ _('–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π PIN') }}" maxlength="4" autocomplete="off" required>
                    </div>
                    <div id="createPinMessage" class="alert" style="display: none;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('–û—Ç–º–µ–Ω–∞') }}</button>
                <button type="button" class="btn btn-primary" onclick="submitCreatePin()">{{ _('–°–æ–∑–¥–∞—Ç—å PIN') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–∫–∞–∑–∞ PIN -->
<div class="modal fade" id="pinShowModal" tabindex="-1" aria-labelledby="pinShowModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pinShowModalLabel">
                    <i class="bi bi-key"></i> {{ _('PIN-–∫–æ–¥ –∏–∑ –∞—Ä—Ö–∏–≤–∞') }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success" role="alert">
                    <i class="bi bi-check-circle"></i>
                    <strong>{{ _('PIN-–∫–æ–¥ –Ω–∞–π–¥–µ–Ω!') }}</strong> {{ _('–ó–∞–ø–æ–º–Ω–∏—Ç–µ –∏–ª–∏ –∑–∞–ø–∏—à–∏—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥.') }}
                </div>
                <div class="text-center">
                    <h3 id="pinDisplay" class="text-primary mb-3"></h3>
                    <p class="text-muted">{{ _('–≠—Ç–æ—Ç PIN-–∫–æ–¥ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö.') }}</p>
                </div>
                <div class="alert alert-warning" role="alert">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>{{ _('–í–∞–∂–Ω–æ:') }}</strong> {{ _('PIN-–∫–æ–¥ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑. –ó–∞–ø–∏—à–∏—Ç–µ –µ–≥–æ!') }}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('–û—Ç–º–µ–Ω–∞') }}</button>
                <button type="button" class="btn btn-primary" onclick="proceedWithImport()">{{ _('–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–º–ø–æ—Ä—Ç') }}</button>
                <button type="button" class="btn btn-success" onclick="importArchiveDataFromPin()">{{ _('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å') }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∫—Ä–∏–ø—Ç–∞
    console.log('–°–∫—Ä–∏–ø—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞–≥—Ä—É–∂–µ–Ω. –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É...');
    
    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    function checkBlockStatus() {
        console.log('–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏...');
        fetch('/pin/check_block', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('–°—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:', data);
            if (data.blocked && data.remaining_seconds > 0) {
                console.log(`–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞ ${data.remaining_seconds} —Å–µ–∫—É–Ω–¥. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫.`);
                showBlockCounter(data.remaining_seconds);
            } else {
                console.log('–ù–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏—Å—Ç–µ–∫–ª–∞.');
                hideBlockCounter();
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:', error);
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å—á–µ—Ç—á–∏–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    function showBlockCounter(remainingSeconds) {
        const blockCounter = document.getElementById('blockCounter');
        const countdown = document.getElementById('countdown');
        const progressBar = document.getElementById('blockProgressBar');
        const pinLoginButton = document.getElementById('pinLoginButton');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
        blockCounter.style.display = 'block';
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤—Ö–æ–¥–∞
        if (pinLoginButton) {
            pinLoginButton.disabled = true;
            pinLoginButton.innerHTML = '<i class="bi bi-lock-fill"></i> ' + '{{ _("–í—Ö–æ–¥ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω") }}';
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
        let secondsLeft = remainingSeconds;
        const totalSeconds = remainingSeconds;
        updateCountdown(secondsLeft, totalSeconds);
        
        const timer = setInterval(() => {
            secondsLeft--;
            updateCountdown(secondsLeft, totalSeconds);
            
            if (secondsLeft <= 0) {
                clearInterval(timer);
                hideBlockCounter();
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
                window.location.reload();
            }
        }, 1000);
        
        function updateCountdown(seconds, total) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            const timeStr = `${minutes}:${secs.toString().padStart(2, '0')}`;
            countdown.textContent = timeStr;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
            const percentLeft = (seconds / total) * 100;
            progressBar.style.width = percentLeft + '%';
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Å–∫—Ä—ã—Ç–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    function hideBlockCounter() {
        const blockCounter = document.getElementById('blockCounter');
        const pinLoginButton = document.getElementById('pinLoginButton');
        
        blockCounter.style.display = 'none';
        
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤—Ö–æ–¥–∞
        if (pinLoginButton) {
            pinLoginButton.disabled = false;
            pinLoginButton.innerHTML = '<i class="bi bi-key"></i> ' + '{{ _("–í–≤–µ—Å—Ç–∏ PIN") }}';
        }
    }
    
    // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å—Ä–∞–∑—É
    checkBlockStatus();

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ "–ü–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞" (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö)
    function checkFirstSetupAllowed() {
        fetch('/pin/check_first_setup_allowed')
            .then(response => response.json())
            .then(data => {
                const button = document.getElementById('firstSetupButton');
                const hint = document.getElementById('firstTimeHint');
                
                if (data.allowed) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–¥—Å–∫–∞–∑–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
                    button.style.display = 'inline-block';
                    hint.style.display = 'block';
                } else {
                    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç (–∑–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞)
                    button.style.display = 'none';
                    hint.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞:', error);
                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                document.getElementById('firstSetupButton').style.display = 'none';
                document.getElementById('firstTimeHint').style.display = 'none';
            });
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å "–ü–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞" –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    checkFirstSetupAllowed();
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—Ö–æ–¥–∞ –ø–æ PIN
    function showPinLoginModal() {
        const modal = new bootstrap.Modal(document.getElementById('pinLoginModal'));
        modal.show();
        
        // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        setTimeout(() => {
            document.getElementById('pinInput').focus();
        }, 500);
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter
        document.getElementById('pinInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitPinLogin();
            }
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
    function showFirstTimeSetup() {
        const modal = new bootstrap.Modal(document.getElementById('firstTimeSetupModal'));
        modal.show();
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ö–∏–≤–∞
    function showArchiveUpload() {
        const modal = new bootstrap.Modal(document.getElementById('archiveUploadModal'));
        modal.show();
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
        const firstTimeModal = bootstrap.Modal.getInstance(document.getElementById('firstTimeSetupModal'));
        if (firstTimeModal) {
            firstTimeModal.hide();
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–æ–≤–æ–≥–æ PIN
    function setupNewPin() {
        const modal = new bootstrap.Modal(document.getElementById('createPinModal'));
        modal.show();
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
        const firstTimeModal = bootstrap.Modal.getInstance(document.getElementById('firstTimeSetupModal'));
        if (firstTimeModal) {
            firstTimeModal.hide();
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ PIN –¥–ª—è –≤—Ö–æ–¥–∞
    function submitPinLogin() {
        const pin = document.getElementById('pinInput').value;
        const messageDiv = document.getElementById('pinLoginMessage');
        const submitButton = document.querySelector('#pinLoginModal .btn-primary');
        
        if (!pin) {
            showPinLoginMessage('{{ _("–í–≤–µ–¥–∏—Ç–µ PIN-–∫–æ–¥") }}', 'danger');
            return;
        }
        
        // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
        submitButton.disabled = true;
        submitButton.textContent = '{{ _("–ü—Ä–æ–≤–µ—Ä–∫–∞...") }}';
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä (v4.0.0 - JSON format)
        console.log('Sending PIN:', pin);
        fetch('/pin/login_ajax', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({pin: pin})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showPinLoginMessage(data.message, 'success');
                setTimeout(() => {
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω—ã–π –¥–∏–∞–ª–æ–≥ –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    const modal = bootstrap.Modal.getInstance(document.getElementById('pinLoginModal'));
                    modal.hide();
                    window.location.href = '/';
                }, 1000);
            } else {
                if (data.blocked) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É —Å —Ç–∞–π–º–µ—Ä–æ–º
                    showPinLoginBlocked(data.remaining_seconds);
                } else {
                    showPinLoginMessage(data.message, 'danger');
                }
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ –ø–æ PIN:', error);
            showPinLoginMessage('{{ _("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º") }}', 'danger');
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            submitButton.disabled = false;
            submitButton.textContent = '{{ _("–í–æ–π—Ç–∏") }}';
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å —Ç–∞–π–º–µ—Ä–æ–º
    function showPinLoginBlocked(remainingSeconds) {
        const messageDiv = document.getElementById('pinLoginMessage');
        const pinInput = document.getElementById('pinInput');
        const submitButton = document.querySelector('#pinLoginModal .btn-primary');
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫—É
        pinInput.disabled = true;
        submitButton.disabled = true;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        messageDiv.className = 'alert alert-warning';
        messageDiv.style.display = 'block';
        
        // –¢–∞–∫–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        showBlockCounter(remainingSeconds);
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
        let secondsLeft = remainingSeconds;
        updateBlockedMessage(secondsLeft);
        
        const timer = setInterval(() => {
            secondsLeft--;
            updateBlockedMessage(secondsLeft);
            
            if (secondsLeft <= 0) {
                clearInterval(timer);
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫—É
                pinInput.disabled = false;
                submitButton.disabled = false;
                messageDiv.style.display = 'none';
                pinInput.value = '';
                pinInput.focus();
                // –°–∫—Ä—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                hideBlockCounter();
            }
        }, 1000);
        
        function updateBlockedMessage(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            const timeStr = `${minutes}:${secs.toString().padStart(2, '0')}`;
            messageDiv.innerHTML = `üîí {{ _("–í—Ö–æ–¥ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞") }} <strong>${timeStr}</strong> {{ _("—Å–µ–∫—É–Ω–¥") }}`;
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    function showPinLoginMessage(message, type) {
        const messageDiv = document.getElementById('pinLoginMessage');
        messageDiv.className = `alert alert-${type}`;
        messageDiv.textContent = message;
        messageDiv.style.display = 'block';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–º–µ–Ω—ã PIN
    function submitChangePin() {
        const form = document.getElementById('changePinForm');
        const formData = new FormData(form);
        const messageDiv = document.getElementById('changePinMessage');
        const submitButton = document.getElementById('modalSubmitBtn');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
        const oldPin = formData.get('old_pin');
        const newPin1 = formData.get('new_pin1');
        const newPin2 = formData.get('new_pin2');
        
        if (!oldPin || !newPin1 || !newPin2) {
            showChangePinMessage('{{ _("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è") }}', 'danger');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–æ–≤—ã–µ PIN —Å–æ–≤–ø–∞–¥–∞—é—Ç
        if (newPin1 !== newPin2) {
            showChangePinMessage('{{ _("–ù–æ–≤—ã–µ PIN-–∫–æ–¥—ã –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç") }}', 'danger');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É
        if (newPin1.length < 4) {
            showChangePinMessage('{{ _("PIN –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞") }}', 'danger');
            return;
        }
        
        // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
        submitButton.disabled = true;
        submitButton.textContent = '{{ _("–ü—Ä–æ–≤–µ—Ä–∫–∞...") }}';
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
        fetch('/pin/change_ajax', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showChangePinMessage('{{ _("PIN —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω!") }}', 'success');
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                form.reset();
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É –≤—Ö–æ–¥–∞
                setTimeout(() => {
                    document.getElementById('login-tab').click();
                }, 1500);
            } else {
                showChangePinMessage('{{ _("–û—à–∏–±–∫–∞:") }} ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showChangePinMessage('{{ _("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ PIN") }}', 'danger');
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            submitButton.disabled = false;
            submitButton.textContent = '{{ _("–°–º–µ–Ω–∏—Ç—å PIN") }}';
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Å–º–µ–Ω—ã PIN
    function showChangePinMessage(message, type) {
        const messageDiv = document.getElementById('changePinMessage');
        messageDiv.className = `alert alert-${type}`;
        messageDiv.textContent = message;
        messageDiv.style.display = 'block';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–æ–≤–æ–≥–æ PIN
    function setupNewPin() {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
        const firstTimeModal = bootstrap.Modal.getInstance(document.getElementById('firstTimeSetupModal'));
        firstTimeModal.hide();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ PIN
        setTimeout(() => {
            const createPinModal = new bootstrap.Modal(document.getElementById('createPinModal'));
            createPinModal.show();
        }, 500);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ö–∏–≤–∞
    function showArchiveUpload() {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
        const firstTimeModal = bootstrap.Modal.getInstance(document.getElementById('firstTimeSetupModal'));
        firstTimeModal.hide();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ö–∏–≤–∞
        setTimeout(() => {
            const archiveModal = new bootstrap.Modal(document.getElementById('archiveUploadModal'));
            archiveModal.show();
        }, 500);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞—Ä—Ö–∏–≤–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ PIN
    function checkArchiveForPin() {
        const fileInput = document.getElementById('archiveFile');
        const messageDiv = document.getElementById('archiveUploadMessage');
        
        if (!fileInput.files[0]) {
            showArchiveMessage('{{ _("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª") }}', 'danger');
            return;
        }
        
        const formData = new FormData();
        formData.append('archive_file', fileInput.files[0]);
        
        fetch('/pin/check_archive', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showArchiveMessage(data.message, 'success');
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º PIN –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                setTimeout(() => {
                    showPinFromArchive(data.pin);
                }, 1000);
            } else {
                showArchiveMessage(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showArchiveMessage('{{ _("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∞—Ä—Ö–∏–≤–∞") }}', 'danger');
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∞—Ä—Ö–∏–≤–∞
    function showArchiveMessage(message, type) {
        const messageDiv = document.getElementById('archiveUploadMessage');
        messageDiv.className = `alert alert-${type}`;
        messageDiv.textContent = message;
        messageDiv.style.display = 'block';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ PIN –∏–∑ –∞—Ä—Ö–∏–≤–∞
    function showPinFromArchive(pin) {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ö–∏–≤–∞
        const archiveModal = bootstrap.Modal.getInstance(document.getElementById('archiveUploadModal'));
        archiveModal.hide();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º PIN
        document.getElementById('pinDisplay').textContent = pin;
        const pinModal = new bootstrap.Modal(document.getElementById('pinShowModal'));
        pinModal.show();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º PIN –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        window.archivePin = pin;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ PIN
    function submitCreatePin() {
        const newPin = document.getElementById('newPinInput').value;
        const confirmPin = document.getElementById('confirmPinInput').value;
        const messageDiv = document.getElementById('createPinMessage');
        const submitButton = document.querySelector('#createPinModal .btn-primary');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ PIN –≤–≤–µ–¥–µ–Ω
        if (!newPin || newPin.length < 4) {
            showCreatePinMessage('{{ _("PIN –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞") }}', 'danger');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ PIN –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω
        if (newPin !== confirmPin) {
            showCreatePinMessage('{{ _("PIN-–∫–æ–¥—ã –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç") }}', 'danger');
            return;
        }
        
        // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
        submitButton.disabled = true;
        submitButton.textContent = '{{ _("–°–æ–∑–¥–∞–Ω–∏–µ...") }}';
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
        const formData = new FormData();
        formData.append('new_pin', newPin);
        
        fetch('/pin/first_time_setup', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showCreatePinMessage('{{ _("PIN —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!") }} {{ _("–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–æ.") }}', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showCreatePinMessage('{{ _("–û—à–∏–±–∫–∞:") }} ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showCreatePinMessage('{{ _("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PIN") }}', 'danger');
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            submitButton.disabled = false;
            submitButton.textContent = '{{ _("–°–æ–∑–¥–∞—Ç—å PIN") }}';
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è PIN
    function showCreatePinMessage(message, type) {
        const messageDiv = document.getElementById('createPinMessage');
        messageDiv.className = `alert alert-${type}`;
        messageDiv.textContent = message;
        messageDiv.style.display = 'block';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∏–º–ø–æ—Ä—Ç–∞
    function proceedWithImport() {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∫–∞–∑–∞ PIN
        const pinModal = bootstrap.Modal.getInstance(document.getElementById('pinShowModal'));
        pinModal.hide();
        
        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞—Å—Ç—Ä–æ–µ–∫
        setTimeout(() => {
            window.location.href = '/settings';
        }, 500);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞—Ä—Ö–∏–≤–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ PIN
    function checkArchiveForPin() {
        console.log('–§—É–Ω–∫—Ü–∏—è checkArchiveForPin –≤—ã–∑–≤–∞–Ω–∞');
        const fileInput = document.getElementById('archiveFile');
        const messageDiv = document.getElementById('archiveMessage');
        const submitButton = document.querySelector('#archiveUploadModal .btn-info');
        
        console.log('fileInput:', fileInput);
        console.log('fileInput.files:', fileInput.files);
        
        if (!fileInput.files[0]) {
            console.log('–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω');
            showArchiveMessage('{{ _("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª") }}', 'danger');
            return;
        }
        
        console.log('–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª:', fileInput.files[0].name);
        
        // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
        submitButton.disabled = true;
        submitButton.textContent = '{{ _("–ü—Ä–æ–≤–µ—Ä–∫–∞...") }}';
        
        const formData = new FormData();
        formData.append('archive_file', fileInput.files[0]);
        
        console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ /pin/check_archive');
        
        fetch('/pin/check_archive', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', response);
            return response.json();
        })
        .then(data => {
            console.log('–î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', data);
            if (data.success) {
                showPinFromArchive(data.pin);
            } else {
                showArchiveMessage(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showArchiveMessage('{{ _("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º") }}', 'danger');
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            submitButton.disabled = false;
            submitButton.textContent = '{{ _("–ü—Ä–æ–≤–µ—Ä–∏—Ç—å PIN") }}';
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∞—Ä—Ö–∏–≤–∞
    function showArchiveMessage(message, type) {
        const messageDiv = document.getElementById('archiveMessage');
        messageDiv.className = `alert alert-${type}`;
        messageDiv.textContent = message;
        messageDiv.style.display = 'block';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ PIN –∏–∑ –∞—Ä—Ö–∏–≤–∞
    function showPinFromArchive(pin) {
        document.getElementById('pinDisplay').textContent = pin;
        const modal = new bootstrap.Modal(document.getElementById('pinShowModal'));
        modal.show();
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ö–∏–≤–∞
        const archiveModal = bootstrap.Modal.getInstance(document.getElementById('archiveUploadModal'));
        if (archiveModal) {
            archiveModal.hide();
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∏–º–ø–æ—Ä—Ç–∞ –∞—Ä—Ö–∏–≤–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
    function importArchiveData() {
        console.log('–§—É–Ω–∫—Ü–∏—è importArchiveData –≤—ã–∑–≤–∞–Ω–∞');
        const fileInput = document.getElementById('archiveFile');
        const messageDiv = document.getElementById('archiveMessage');
        const submitButton = document.querySelector('#archiveUploadModal .btn-success');
        
        console.log('fileInput:', fileInput);
        console.log('fileInput.files:', fileInput.files);
        
        if (!fileInput.files[0]) {
            console.log('–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω');
            showArchiveMessage('{{ _("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª") }}', 'danger');
            return;
        }
        
        console.log('–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª:', fileInput.files[0].name);
        
        // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
        submitButton.disabled = true;
        submitButton.textContent = '{{ _("–ò–º–ø–æ—Ä—Ç...") }}';
        
        const formData = new FormData();
        formData.append('archive_file', fileInput.files[0]);
        
        console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ /pin/import_archive');
        
        fetch('/pin/import_archive', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', response);
            return response.json();
        })
        .then(data => {
            console.log('–î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', data);
            if (data.success) {
                showArchiveMessage('{{ _("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!") }} {{ _("–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...") }}', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showArchiveMessage('{{ _("–û—à–∏–±–∫–∞:") }} ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showArchiveMessage('{{ _("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º") }}', 'danger');
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            submitButton.disabled = false;
            submitButton.textContent = '{{ _("–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ") }}';
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∏–º–ø–æ—Ä—Ç–∞ –∞—Ä—Ö–∏–≤–∞ –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–∫–∞–∑–∞ PIN
    function importArchiveDataFromPin() {
        const fileInput = document.getElementById('archiveFile');
        
        if (!fileInput.files[0]) {
            alert('{{ _("–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω") }}');
            return;
        }
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∫–∞–∑–∞ PIN
        const pinModal = bootstrap.Modal.getInstance(document.getElementById('pinShowModal'));
        pinModal.hide();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –∏–º–ø–æ—Ä—Ç–∞
        const messageDiv = document.getElementById('archiveMessage');
        messageDiv.className = 'alert alert-info';
        messageDiv.textContent = '{{ _("–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö...") }}';
        messageDiv.style.display = 'block';
        
        const formData = new FormData();
        formData.append('archive_file', fileInput.files[0]);
        
        fetch('/pin/import_archive', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                messageDiv.className = 'alert alert-success';
                messageDiv.textContent = '{{ _("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!") }} {{ _("–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...") }}';
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                messageDiv.className = 'alert alert-danger';
                messageDiv.textContent = '{{ _("–û—à–∏–±–∫–∞:") }} ' + data.message;
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            messageDiv.className = 'alert alert-danger';
            messageDiv.textContent = '{{ _("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º") }}';
        });
    }
    

    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–º–µ–Ω—ã –≤–∫–ª–∞–¥–æ–∫
    document.addEventListener('DOMContentLoaded', function() {
        document.addEventListener('click', function(e) {
            const submitButton = document.getElementById('modalSubmitBtn');
            if (e.target.id === 'change-pin-tab') {
                submitButton.textContent = '{{ _("–°–º–µ–Ω–∏—Ç—å PIN") }}';
                submitButton.onclick = submitChangePin;
                submitButton.className = 'btn btn-warning';
            } else if (e.target.id === 'login-tab') {
                submitButton.textContent = '{{ _("–í–æ–π—Ç–∏") }}';
                submitButton.onclick = submitPinLogin;
                submitButton.className = 'btn btn-primary';
            }
        });
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –ø–æ –∏–º–µ–Ω–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
    document.addEventListener('DOMContentLoaded', function() {
        const developerName = document.querySelector('footer p');
        if (developerName) {
            let clickCount = 0;
            let clickTimer = null;
            
            developerName.addEventListener('click', function() {
                clickCount++;
                
                if (clickCount === 1) {
                    clickTimer = setTimeout(() => {
                        clickCount = 0;
                    }, 300);
                } else if (clickCount === 2) {
                    clearTimeout(clickTimer);
                    clickCount = 0;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç "–ö—É—Ä–µ–∏–Ω –ú. –ù."
                    if (developerName.textContent.includes('–ö—É—Ä–µ–∏–Ω –ú. –ù.')) {
                        showPinLoginModal();
                    }
                }
            });
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ input
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('archiveFile');
        const fileDisplay = document.getElementById('archiveFileDisplay');
        const fileText = document.querySelector('#archiveUploadForm .form-text');
        
        if (fileInput && fileDisplay) {
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    fileDisplay.value = this.files[0].name;
                    fileText.textContent = '{{ _("–§–∞–π–ª –≤—ã–±—Ä–∞–Ω") }}';
                    fileText.className = 'form-text text-success';
                } else {
                    fileDisplay.value = '';
                    fileText.textContent = '{{ _("–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω") }}';
                    fileText.className = 'form-text text-muted';
                }
            });
        }
    });
</script>
{% endblock %} 