# Урок 5: Расширенные возможности GitHub CLI и интеграции

В этом уроке мы рассмотрим расширенные возможности GitHub CLI, включая работу с расширениями, использование API GitHub, автоматизацию рабочих процессов и интеграцию с другими инструментами.

## Расширения GitHub CLI

GitHub CLI поддерживает систему расширений, которая позволяет добавлять новые команды и функциональность.

### Управление расширениями

```bash
# Просмотр установленных расширений
gh extension list

# Поиск расширений
gh extension search "keyword"

# Установка расширения
gh extension install owner/repo

# Обновление всех расширений
gh extension upgrade --all

# Удаление расширения
gh extension remove extension-name
```

### Полезные расширения

1. **gh-copilot** — интеграция с GitHub Copilot прямо в терминале
   ```bash
   gh extension install github/gh-copilot
   ```

2. **gh-dash** — интерактивная панель для просмотра PR и issues
   ```bash
   gh extension install dlvhdr/gh-dash
   ```

3. **gh-markdown-preview** — предпросмотр Markdown-файлов
   ```bash
   gh extension install yusukebe/gh-markdown-preview
   ```

4. **gh-act** — локальный запуск GitHub Actions
   ```bash
   gh extension install nektos/gh-act
   ```

5. **gh-repo-collab** — управление сотрудниками репозитория
   ```bash
   gh extension install github/gh-repo-collab
   ```

### Создание собственного расширения

Вы можете создать собственное расширение для GitHub CLI:

```bash
# Создание нового расширения
gh extension create my-extension

# Это создаст шаблон расширения в директории gh-my-extension
cd gh-my-extension

# Редактирование скрипта расширения
# Для bash-расширения редактируем gh-my-extension
# Для Go-расширения редактируем main.go

# Установка расширения локально для тестирования
gh extension install .
```

## Работа с GitHub API

GitHub CLI предоставляет доступ к GitHub API через команду `gh api`.

### Основы использования API

```bash
# Базовый запрос GET
gh api repos/{owner}/{repo}

# Запрос с параметрами
gh api search/repositories?q=tetris+language:assembly&sort=stars

# POST запрос
gh api repos/{owner}/{repo}/issues -f title="Bug report" -f body="Something is broken"

# PUT запрос
gh api repos/{owner}/{repo}/issues/123/labels -X PUT -f labels='["bug", "critical"]'

# DELETE запрос
gh api repos/{owner}/{repo}/issues/123/labels/bug -X DELETE
```

### Форматирование вывода API

```bash
# Вывод в формате JSON
gh api repos/{owner}/{repo} --jq '.name'

# Вывод в формате таблицы
gh api repos/{owner}/{repo}/issues --jq '.[] | {number, title, state}' | jq -r '(["NUMBER", "TITLE", "STATE"] | (., map(length*"-"))), (.[] | [.number, .title, .state] | @tsv)' | column -t

# Сохранение вывода в файл
gh api repos/{owner}/{repo}/readme | jq -r '.content' | base64 -d > README.md
```

## Автоматизация с помощью GitHub CLI

GitHub CLI особенно полезен для автоматизации повторяющихся задач.

### Автоматизация рабочих процессов

#### Скрипт для создания PR с шаблоном

```bash
#!/bin/bash
# create-pr.sh

BRANCH_NAME=$(git branch --show-current)
ISSUE_NUMBER=$(echo $BRANCH_NAME | grep -o '[0-9]\+')

if [ -n "$ISSUE_NUMBER" ]; then
  ISSUE_TITLE=$(gh issue view $ISSUE_NUMBER --json title -q .title)
  gh pr create --title "[$ISSUE_NUMBER] $ISSUE_TITLE" --body "Closes #$ISSUE_NUMBER" --assignee @me
else
  gh pr create --title "$(git log -1 --pretty=%s)" --assignee @me
fi
```

#### Скрипт для проверки и слияния PR

```bash
#!/bin/bash
# review-and-merge.sh

PR_NUMBER=$1

if [ -z "$PR_NUMBER" ]; then
  echo "Usage: $0 <pr-number>"
  exit 1
fi

# Проверка PR
gh pr checkout $PR_NUMBER
npm test

# Если тесты прошли успешно, одобряем и сливаем PR
if [ $? -eq 0 ]; then
  gh pr review $PR_NUMBER --approve
  gh pr merge $PR_NUMBER --squash
else
  echo "Tests failed, not approving PR"
  exit 1
fi
```

### Интеграция с CI/CD

#### Автоматическое закрытие issues при слиянии PR

```bash
#!/bin/bash
# close-issues.sh

PR_NUMBER=$1

# Получаем список issues, которые закрываются этим PR
ISSUES=$(gh pr view $PR_NUMBER --json body -q '.body' | grep -o '#[0-9]\+' | tr -d '#')

for ISSUE in $ISSUES; do
  echo "Closing issue #$ISSUE"
  gh issue close $ISSUE --comment "Closed by PR #$PR_NUMBER"
done
```

## Интеграция с другими инструментами

### Интеграция с VS Code

```bash
# Открытие репозитория в VS Code
gh repo clone owner/repo && code owner/repo

# Открытие PR в VS Code
gh pr checkout 123 && code .
```

### Интеграция с Docker

```bash
# Запуск GitHub CLI в Docker
docker run --rm -it -v "$(pwd):/workspace" -w /workspace ghcr.io/cli/cli:latest repo view

# Использование GitHub CLI в Docker-контейнере с аутентификацией
docker run --rm -it -v "${HOME}/.config/gh:/root/.config/gh" -v "$(pwd):/workspace" -w /workspace ghcr.io/cli/cli:latest auth status
```

### Интеграция с Git-хуками

#### pre-commit хук для проверки issues перед коммитом

```bash
#!/bin/bash
# .git/hooks/pre-commit

BRANCH_NAME=$(git branch --show-current)
ISSUE_NUMBER=$(echo $BRANCH_NAME | grep -o '[0-9]\+')

if [ -n "$ISSUE_NUMBER" ]; then
  if ! gh issue view $ISSUE_NUMBER &> /dev/null; then
    echo "Error: Issue #$ISSUE_NUMBER does not exist or you don't have access to it."
    exit 1
  fi
fi

exit 0
```

### Интеграция с Continuous Integration

#### GitHub Actions для автоматической проверки PR

```yaml
# .github/workflows/review-pr.yml
name: Review PR

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup GitHub CLI
        run: |
          gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"
      - name: Check PR title format
        run: |
          PR_TITLE=$(gh pr view ${{ github.event.pull_request.number }} --json title -q .title)
          if ! echo "$PR_TITLE" | grep -q "^\[.*\]"; then
            gh pr comment ${{ github.event.pull_request.number }} --body "PR title should start with a tag in square brackets, e.g. [Feature], [Bug], [Docs]"
          fi
```

## Практические примеры

### Пример 1: Скрипт для создания релизов

```bash
#!/bin/bash
# create-release.sh

VERSION=$1
PREV_VERSION=$2

if [ -z "$VERSION" ] || [ -z "$PREV_VERSION" ]; then
  echo "Usage: $0 <new-version> <previous-version>"
  exit 1
fi

# Генерируем список изменений
CHANGELOG=$(gh pr list --base main --state merged --limit 100 --json number,title,mergedAt --jq '.[] | select(.mergedAt > "'"$(gh release view $PREV_VERSION --json publishedAt -q .publishedAt)"'") | "- #\(.number) \(.title)"' | sort)

# Создаем релиз
gh release create $VERSION -t "Release $VERSION" -n "## Changes since $PREV_VERSION

$CHANGELOG

## Installation

\`\`\`bash
npm install my-package@$VERSION
\`\`\`
"
```

### Пример 2: Скрипт для анализа активности репозитория

```bash
#!/bin/bash
# repo-activity.sh

REPO=$1
DAYS=${2:-30}

if [ -z "$REPO" ]; then
  echo "Usage: $0 <owner/repo> [days]"
  exit 1
fi

SINCE=$(date -v-${DAYS}d +%Y-%m-%d)

echo "Activity in $REPO for the last $DAYS days:"
echo

echo "## Pull Requests"
gh pr list --repo $REPO --state all --limit 100 --json number,title,state,createdAt --jq '.[] | select(.createdAt > "'"$SINCE"'") | "\(.number) | \(.title) | \(.state) | \(.createdAt)"' | column -t -s '|'
echo

echo "## Issues"
gh issue list --repo $REPO --state all --limit 100 --json number,title,state,createdAt --jq '.[] | select(.createdAt > "'"$SINCE"'") | "\(.number) | \(.title) | \(.state) | \(.createdAt)"' | column -t -s '|'
echo

echo "## Releases"
gh release list --repo $REPO --limit 10 --json tagName,name,publishedAt --jq '.[] | select(.publishedAt > "'"$SINCE"'") | "\(.tagName) | \(.name) | \(.publishedAt)"' | column -t -s '|'
```

### Пример 3: Интерактивный скрипт для управления issues

```bash
#!/bin/bash
# interactive-issues.sh

# Функция для отображения меню
show_menu() {
  echo "GitHub Issues Manager"
  echo "1. List open issues"
  echo "2. Create new issue"
  echo "3. Close issue"
  echo "4. Assign issue to me"
  echo "5. Add label to issue"
  echo "0. Exit"
  echo -n "Choose an option: "
}

# Основной цикл
while true; do
  show_menu
  read -r option

  case $option in
    1)
      echo "Open issues:"
      gh issue list
      ;;
    2)
      echo "Creating new issue..."
      gh issue create
      ;;
    3)
      echo -n "Enter issue number to close: "
      read -r issue_number
      gh issue close "$issue_number"
      ;;
    4)
      echo -n "Enter issue number to assign to yourself: "
      read -r issue_number
      gh issue edit "$issue_number" --add-assignee @me
      ;;
    5)
      echo -n "Enter issue number: "
      read -r issue_number
      echo -n "Enter label to add: "
      read -r label
      gh issue edit "$issue_number" --add-label "$label"
      ;;
    0)
      echo "Goodbye!"
      exit 0
      ;;
    *)
      echo "Invalid option"
      ;;
  esac

  echo
  echo "Press Enter to continue..."
  read -r
  clear
done
```

## Советы и рекомендации

1. **Используйте алиасы** для часто используемых команд:
   ```bash
   # Добавление в ~/.bashrc или ~/.zshrc
   alias ghi="gh issue"
   alias ghpr="gh pr"
   alias ghrun="gh run"
   ```

2. **Настройте автодополнение** для GitHub CLI:
   ```bash
   # Для Bash
   gh completion -s bash > ~/.gh-completion.bash
   echo "source ~/.gh-completion.bash" >> ~/.bashrc

   # Для Zsh
   gh completion -s zsh > ~/.zsh/_gh
   echo "fpath=(~/.zsh $fpath)" >> ~/.zshrc
   ```

3. **Используйте переменные окружения** для настройки GitHub CLI:
   ```bash
   # Настройка редактора
   export GH_EDITOR=vim

   # Настройка браузера
   export BROWSER=firefox
   ```

4. **Создавайте скрипты** для автоматизации повторяющихся задач и добавляйте их в PATH.

## Заключение

GitHub CLI — это мощный инструмент, который можно расширять и интегрировать с другими инструментами для создания эффективного рабочего процесса. Используя расширения, API и автоматизацию, вы можете значительно повысить продуктивность работы с GitHub.

Продолжайте изучать новые возможности GitHub CLI и экспериментировать с различными интеграциями, чтобы найти оптимальный рабочий процесс для вашего проекта.

## Дополнительные ресурсы

- [GitHub CLI API документация](https://cli.github.com/manual/gh_api)
- [Репозиторий GitHub CLI Extensions](https://github.com/topics/gh-extension)
- [GitHub REST API документация](https://docs.github.com/rest)
- [GitHub GraphQL API документация](https://docs.github.com/graphql) 